<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="common-styles.css">
    <script src="webview-compat.js"></script>
    <script src="theme-manager.js"></script>
    <script src="utils.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* 深色主题样式 */
        body.theme-dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        body.theme-dark .bg-white {
            background-color: #2d2d2d !important;
        }
        
        body.theme-dark .bg-gray-50 {
            background-color: #1a1a1a !important;
        }
        
        body.theme-dark .text-gray-800 {
            color: #ffffff !important;
        }
        
        body.theme-dark .text-gray-600 {
            color: #cccccc !important;
        }
        
        body.theme-dark .text-gray-500 {
            color: #999999 !important;
        }
        
        body.theme-dark .text-gray-400 {
            color: #777777 !important;
        }
        
        body.theme-dark .border-gray-200 {
            border-color: #404040 !important;
        }
        
        body.theme-dark .border-gray-100 {
            border-color: #333333 !important;
        }
        
        body.theme-dark .bg-gray-100 {
            background-color: #333333 !important;
        }
        
        body.theme-dark .bg-gray-200 {
            background-color: #404040 !important;
        }
        /* 页面特定的切换开关样式覆盖 */
        .toggle-switch {
            width: 50px;
            height: 28px;
        }
        .slider {
            border-radius: 28px;
        }
        .slider:before {
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .theme-preview {
            transition: all 0.3s ease;
        }
        .theme-preview.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-50">


    <!-- 主内容区域 -->
    <div class="bg-white min-h-screen">
        <!-- 头部导航 -->
        <div class="bg-white px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-arrow-left text-gray-600 text-lg cursor-pointer"></i>
                    <h1 class="text-xl font-semibold text-gray-800">设置</h1>
                </div>
                <i class="fas fa-question-circle text-gray-400 text-lg cursor-pointer"></i>
            </div>
        </div>

        <!-- 主题设置 -->
        <div class="px-6 py-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">主题设置</h3>
            <div class="bg-white rounded-2xl p-6 border border-gray-200">
                <div class="grid grid-cols-3 gap-4">
                    <!-- 浅色主题 -->
                    <div class="theme-preview active border-2 border-gray-200 rounded-xl p-3 cursor-pointer" data-theme="light">
                        <div class="bg-white rounded-lg p-2 mb-2">
                            <div class="h-2 bg-gray-200 rounded mb-1"></div>
                            <div class="h-1 bg-gray-100 rounded"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600 font-medium">浅色</div>
                    </div>
                    
                    <!-- 深色主题 -->
                    <div class="theme-preview border-2 border-gray-200 rounded-xl p-3 cursor-pointer" data-theme="dark">
                        <div class="bg-gray-800 rounded-lg p-2 mb-2">
                            <div class="h-2 bg-gray-600 rounded mb-1"></div>
                            <div class="h-1 bg-gray-700 rounded"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600 font-medium">深色</div>
                    </div>
                    
                    <!-- 自动主题 -->
                    <div class="theme-preview border-2 border-gray-200 rounded-xl p-3 cursor-pointer" data-theme="auto">
                        <div class="bg-gradient-to-r from-white to-gray-800 rounded-lg p-2 mb-2">
                            <div class="h-2 bg-gradient-to-r from-gray-200 to-gray-600 rounded mb-1"></div>
                            <div class="h-1 bg-gradient-to-r from-gray-100 to-gray-700 rounded"></div>
                        </div>
                        <div class="text-xs text-center text-gray-600 font-medium">自动</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 答题设置 -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">答题设置</h3>
            <div class="bg-white rounded-2xl border border-gray-200">
                <!-- 弹窗延时设置 -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-medium text-gray-800">答案弹窗显示时长</h4>
                            <p class="text-sm text-gray-500">设置答案弹窗显示的持续时间</p>
                        </div>
                        <span id="delayValue" class="text-blue-600 font-semibold">1000ms</span>
                    </div>
                    <input type="range" id="delaySlider" class="range-slider w-full" min="100" max="2000" value="1000" step="100">
                    <div class="flex justify-between text-xs text-gray-400 mt-2">
                        <span>100ms</span>
                        <span>1000ms</span>
                        <span>2000ms</span>
                    </div>
                </div>
                
                <!-- 自动下一题 -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-800">自动下一题</h4>
                            <p class="text-sm text-gray-500">答题后自动跳转到下一题</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 震动反馈 -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-800">震动反馈</h4>
                            <p class="text-sm text-gray-500">答错时提供震动提醒</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 音效提示 -->
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-800">音效提示</h4>
                            <p class="text-sm text-gray-500">答题时播放音效</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 学习设置 -->
        <div class="px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">学习设置</h3>
            <div class="bg-white rounded-2xl border border-gray-200">
                <!-- 每日目标 -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-medium text-gray-800">每日学习目标</h4>
                            <p class="text-sm text-gray-500">设置每天要完成的题目数量</p>
                        </div>
                        <span id="targetValue" class="text-blue-600 font-semibold">20题</span>
                    </div>
                    <input type="range" id="targetSlider" class="range-slider w-full" min="5" max="100" value="20" step="5">
                    <div class="flex justify-between text-xs text-gray-400 mt-2">
                        <span>5题</span>
                        <span>50题</span>
                        <span>100题</span>
                    </div>
                </div>
                
                <!-- 学习提醒 -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-800">学习提醒</h4>
                            <p class="text-sm text-gray-500">每日定时提醒学习</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 错题复习提醒 -->
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-800">错题复习提醒</h4>
                            <p class="text-sm text-gray-500">定期提醒复习错题</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>



        <!-- 关于应用 -->
        <div class="px-6 py-4 pb-24">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">关于应用</h3>
            <div class="bg-white rounded-2xl border border-gray-200">
                <!-- 版本信息 -->
                <div class="card-hover p-6 border-b border-gray-100 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-info-circle text-purple-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">版本信息</h4>
                                <p class="text-sm text-gray-500">v1.2.0</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
                
                <!-- 用户协议 -->
                <div class="card-hover p-6 border-b border-gray-100 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-file-contract text-gray-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">用户协议</h4>
                                <p class="text-sm text-gray-500">查看用户使用协议</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
                
                <!-- 隐私政策 -->
                <div class="card-hover p-6 border-b border-gray-100 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-shield-alt text-gray-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">隐私政策</h4>
                                <p class="text-sm text-gray-500">查看隐私保护政策</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
                
                <!-- 意见反馈 -->
                <div class="card-hover p-6 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-comment text-yellow-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">意见反馈</h4>
                                <p class="text-sm text-gray-500">提交问题和建议</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3">
        <div class="flex justify-around items-center">
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="main">
                <i class="fas fa-home text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">首页</span>
            </div>
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="wrong">
                <i class="fas fa-exclamation-triangle text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">错题</span>
            </div>
        </div>
    </div>

    <script>
        // 设置数据管理
        let settings = {
            theme: 'light',
            answerDelay: 1000,
            autoNext: true,
            vibration: false,
            sound: true,
            dailyTarget: 20,
            studyReminder: true,
            wrongReminder: true
        };

        // 页面初始化
        function initPage() {
            loadSettings();
            updateUI();
            bindEvents();
        }

        // 加载设置
        function loadSettings() {
            const savedSettings = WebViewCompat.storage.getItem('appSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
        }

        // 保存设置
        function saveSettings() {
            WebViewCompat.storage.setItem('appSettings', JSON.stringify(settings));
            
            // 触发数据更新事件
            window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                detail: { type: 'settings', data: settings }
            }));
            
            // 发送消息给父窗口
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    action: 'practiceDataUpdated',
                    type: 'settings',
                    data: settings
                }, '*');
            }
            
            showToast('设置已保存');
        }

        // 更新UI
        function updateUI() {
            // 更新主题选择
            document.querySelectorAll('.theme-preview').forEach(theme => {
                theme.classList.remove('active');
                if (theme.dataset.theme === settings.theme) {
                    theme.classList.add('active');
                }
            });

            // 更新滑块值
            document.getElementById('delaySlider').value = settings.answerDelay;
            document.getElementById('delayValue').textContent = settings.answerDelay + 'ms';
            document.getElementById('targetSlider').value = settings.dailyTarget;
            document.getElementById('targetValue').textContent = settings.dailyTarget + '题';

            // 更新开关状态
            const toggles = document.querySelectorAll('.toggle-switch input');
            toggles[0].checked = settings.autoNext;
            toggles[1].checked = settings.vibration;
            toggles[2].checked = settings.sound;
            toggles[3].checked = settings.studyReminder;
            toggles[4].checked = settings.wrongReminder;
        }

        // 应用主题
        function applyTheme(theme) {
            settings.theme = theme;
            
            // 使用全局主题管理器
            if (window.themeManager) {
                window.themeManager.setTheme(theme);
            }
            
            // 显示提示消息
            if (theme === 'dark') {
                showToast('已切换到深色主题');
            } else if (theme === 'auto') {
                const isDark = window.themeManager ? window.themeManager.shouldUseDarkMode() : false;
                if (isDark) {
                    showToast('已切换到自动主题（当前为深色）');
                } else {
                    showToast('已切换到自动主题（当前为浅色）');
                }
            } else {
                showToast('已切换到浅色主题');
            }
            
            saveSettings();
        }

        // 返回上一页
        function goBack() {
            if (window.parent !== window) {
                window.parent.postMessage({ action: 'navigate', page: 'main' }, '*');
            } else {
                window.location.href = 'main.html';
            }
        }

        // 绑定事件
        function bindEvents() {
            // 返回按钮
            document.querySelector('.fas.fa-arrow-left').addEventListener('click', goBack);

            // 帮助按钮
            document.querySelector('.fas.fa-question-circle').addEventListener('click', showHelp);

            // 主题切换
            document.querySelectorAll('.theme-preview').forEach(theme => {
                theme.addEventListener('click', function() {
                    document.querySelectorAll('.theme-preview').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const themeType = this.dataset.theme;
                    applyTheme(themeType);
                });
            });
            
            // 弹窗延时滑块
            const delaySlider = document.getElementById('delaySlider');
            const delayValue = document.getElementById('delayValue');
            
            delaySlider.addEventListener('input', function() {
                settings.answerDelay = parseInt(this.value);
                delayValue.textContent = this.value + 'ms';
                saveSettings();
            });
            
            // 每日目标滑块
            const targetSlider = document.getElementById('targetSlider');
            const targetValue = document.getElementById('targetValue');
            
            targetSlider.addEventListener('input', function() {
                settings.dailyTarget = parseInt(this.value);
                targetValue.textContent = this.value + '题';
                saveSettings();
            });
            
            // 开关切换功能
            const toggles = document.querySelectorAll('.toggle-switch input');
            const settingKeys = ['autoNext', 'vibration', 'sound', 'studyReminder', 'wrongReminder'];
            
            toggles.forEach((toggle, index) => {
                toggle.addEventListener('change', function() {
                    settings[settingKeys[index]] = this.checked;
                    saveSettings();
                    
                    // 特殊处理
                    if (settingKeys[index] === 'vibration' && this.checked) {
                        // 测试震动
                        if (navigator.vibrate) {
                            navigator.vibrate(100);
                        }
                    }
                });
            });



            // 关于应用功能
            const dataSections = document.querySelectorAll('h3');
            let aboutSection = null;
            dataSections.forEach(h3 => {
                if (h3.textContent.includes('关于应用')) {
                    aboutSection = h3;
                }
            });
            if (aboutSection) {
                const aboutContainer = aboutSection.nextElementSibling;
                const aboutActions = aboutContainer.querySelectorAll('.card-hover');
                if (aboutActions[0]) aboutActions[0].addEventListener('click', showVersion);
                if (aboutActions[1]) aboutActions[1].addEventListener('click', showUserAgreement);
                if (aboutActions[2]) aboutActions[2].addEventListener('click', showPrivacyPolicy);
                if (aboutActions[3]) aboutActions[3].addEventListener('click', showFeedback);
            }

            // 底部导航事件绑定已移至bindBottomNavigation函数
        }



        // 显示版本信息
        function showVersion() {
            WebViewCompat.dialog.alert('智能刷题 v1.2.0\n\n更新内容：\n- 新增主题切换功能\n- 优化答题体验\n- 修复已知问题\n\n开发者：学习助手团队');
        }

        // 显示用户协议
        function showUserAgreement() {
            WebViewCompat.dialog.alert('用户协议\n\n1. 本应用仅供学习使用\n2. 请合理安排学习时间\n3. 尊重知识产权\n4. 禁止恶意使用\n\n详细协议请访问官网查看。');
        }

        // 显示隐私政策
        function showPrivacyPolicy() {
            WebViewCompat.dialog.alert('隐私政策\n\n我们承诺：\n1. 不收集个人敏感信息\n2. 学习数据仅存储在本地\n3. 不向第三方分享用户数据\n4. 用户可随时删除数据\n\n详细政策请访问官网查看。');
        }

        // 显示反馈页面
        function showFeedback() {
            const feedback = WebViewCompat.dialog.prompt('请输入您的意见或建议：');
            if (feedback && feedback.trim()) {
                showToast('感谢您的反馈！我们会认真考虑您的建议。');
            }
        }

        // 显示帮助
        function showHelp() {
            WebViewCompat.dialog.alert('设置帮助\n\n主题设置：选择应用外观主题\n答题设置：调整答题相关功能\n学习设置：设置学习目标和提醒\n数据管理：管理学习数据\n\n如有其他问题，请通过意见反馈联系我们。');
        }

        // 显示提示消息
        function showToast(message) {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50 transition-opacity';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3秒后移除
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 获取设置值（供其他页面调用）
        function getSettings() {
            return settings;
        }

        // 底部导航功能
        function bindBottomNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            function navigateToPage(page) {
                window.NavigationUtils.navigateToPage(page);
            }
            
            navItems.forEach((item) => {
                item.addEventListener('click', function() {
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化主题
            if (window.themeManager) {
                window.themeManager.init();
            }
            
            initPage();
            bindBottomNavigation();
        });
        
        // 暴露设置获取函数到全局
        window.getAppSettings = getSettings;
    </script>
</body>
</html>