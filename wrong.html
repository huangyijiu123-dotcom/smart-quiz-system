<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>错题库</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="common-styles.css">
    <script src="webview-compat.js"></script>
    <script src="theme-manager.js"></script>
    <script src="utils.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        /* card-hover样式已移至common-styles.css */
        .empty-state {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .difficulty-easy { background: linear-gradient(135deg, #10b981, #34d399); }
        .difficulty-medium { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .difficulty-hard { background: linear-gradient(135deg, #ef4444, #f87171); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 主内容区域 -->
    <div class="bg-white min-h-screen">
        <!-- 头部导航 -->
        <div class="bg-white px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <i class="fas fa-arrow-left text-gray-600 text-lg cursor-pointer"></i>
                <h1 class="text-xl font-semibold text-gray-800">错题库</h1>
                <div class="w-6"></div> <!-- 占位符保持居中 -->
            </div>
        </div>





        <!-- 错题分类 -->
        <div class="px-6 py-2">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">错题分类</h3>
                <div class="flex items-center space-x-3">
                    <button onclick="resetWrongQuestions()" class="text-sm text-red-500 flex items-center">
                        <i class="fas fa-trash-alt mr-1"></i>重置错题库
                    </button>
                    <span class="text-sm text-gray-500">按题型分组</span>
                </div>
            </div>
            
            <div class="space-y-4">
                <!-- 单选题错题 -->
                <div class="bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-dot-circle text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">单选题</h4>
                                <p class="text-sm text-gray-500"><span id="single-wrong-count">0</span>道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full"><span id="single-total-count">0</span>题</span>
                        </div>
                    </div>
                    
                    <!-- 单选题练习按钮区域 -->
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <!-- 继续练习按钮 -->
                        <div id="single-continue-card" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-3 border border-green-200" style="display: none;">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-history text-green-600 mr-1"></i>
                                <span id="single-progress-info">第0题/共0题 (0%)</span>
                            </div>
                            <button id="single-continue-btn" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.continuePractice('单选题')">
                                继续练习
                            </button>
                        </div>
                        
                        <!-- 新的开始练习按钮 -->
                        <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-3 border border-red-200">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-play text-red-600 mr-1"></i>
                                <span>开始新的练习</span>
                            </div>
                            <button class="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.startPractice('单选题')">
                                开始练习
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 多选题错题 -->
                <div class="bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-square text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">多选题</h4>
                                <p class="text-sm text-gray-500"><span id="multiple-wrong-count">0</span>道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full"><span id="multiple-total-count">0</span>题</span>
                        </div>
                    </div>
                    
                    <!-- 多选题练习按钮区域 -->
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <!-- 继续练习按钮 -->
                        <div id="multiple-continue-card" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-3 border border-green-200" style="display: none;">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-history text-green-600 mr-1"></i>
                                <span id="multiple-progress-info">第0题/共0题 (0%)</span>
                            </div>
                            <button id="multiple-continue-btn" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.continuePractice('多选题')">
                                继续练习
                            </button>
                        </div>
                        
                        <!-- 新的开始练习按钮 -->
                        <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-3 border border-red-200">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-play text-red-600 mr-1"></i>
                                <span>开始新的练习</span>
                            </div>
                            <button class="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.startPractice('多选题')">
                                开始练习
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 判断题错题 -->
                <div class="bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-question-circle text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">判断题</h4>
                                <p class="text-sm text-gray-500"><span id="judge-wrong-count">0</span>道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full"><span id="judge-total-count">0</span>题</span>
                        </div>
                    </div>
                    
                    <!-- 判断题练习按钮区域 -->
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <!-- 继续练习按钮 -->
                        <div id="judge-continue-card" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-3 border border-green-200" style="display: none;">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-history text-green-600 mr-1"></i>
                                <span id="judge-progress-info">第0题/共0题 (0%)</span>
                            </div>
                            <button id="judge-continue-btn" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.continuePractice('判断题')">
                                继续练习
                            </button>
                        </div>
                        
                        <!-- 新的开始练习按钮 -->
                        <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-3 border border-red-200">
                            <div class="text-sm text-gray-700 mb-2">
                                <i class="fas fa-play text-red-600 mr-1"></i>
                                <span>开始新的练习</span>
                            </div>
                            <button class="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-2 rounded-lg text-sm font-medium" onclick="wrongPractice.startPractice('判断题')">
                                开始练习
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- 空状态页面（当没有错题时显示） -->
        <div id="emptyState" class="hidden px-6 py-12 text-center empty-state">
            <div class="w-32 h-32 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check-circle text-6xl text-green-500"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">太棒了！</h3>
            <p class="text-gray-500 mb-6">目前没有错题，继续保持这个好习惯</p>
            <button class="bg-gradient-to-r from-blue-500 to-purple-500 text-white font-medium px-8 py-3 rounded-2xl card-hover">
                开始新的练习
            </button>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3">
        <div class="flex justify-around items-center">
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="main">
                <i class="fas fa-home text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">首页</span>
            </div>
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="wrong">
                <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                <span class="text-xs text-red-600 font-medium">错题</span>
            </div>
        </div>
    </div>

    <script>
        // 错题数据（过滤掉已移出的错题）
        let allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
        let wrongQuestions = allWrongQuestions.filter(q => !q.isRemoved);
        
        // 当前筛选条件
        let currentFilter = '单选题'; // 单选题, 多选题, 判断题
        let currentSort = 'time'; // time, difficulty, wrongCount
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 初始化主题
                if (window.themeManager) {
                    window.themeManager.init();
                }
                
                loadWrongQuestions();
                updateStatistics();
                renderWrongQuestions();
                updateInterfaceState();
                bindEvents();
            } catch (error) {
                console.error('页面初始化失败:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });
        
        // 加载错题数据（过滤已移出的错题）
        function loadWrongQuestions() {
            allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            wrongQuestions = allWrongQuestions.filter(q => !q.isRemoved);
        }
        
        // 更新统计数据
        function updateStatistics() {
            // 更新分类统计
            const singleChoice = wrongQuestions.filter(q => q.type === '单选题').length;
            const multiChoice = wrongQuestions.filter(q => q.type === '多选题').length;
            const judgment = wrongQuestions.filter(q => q.type === '判断题').length;
            
            // 更新错题计数显示
            document.getElementById('single-wrong-count').textContent = singleChoice;
            document.getElementById('single-total-count').textContent = singleChoice;
            
            document.getElementById('multiple-wrong-count').textContent = multiChoice;
            document.getElementById('multiple-total-count').textContent = multiChoice;
            
            document.getElementById('judge-wrong-count').textContent = judgment;
            document.getElementById('judge-total-count').textContent = judgment;
            
            const categoryCards = document.querySelectorAll('.space-y-3 .card-hover');
            if (categoryCards.length >= 3) {
                categoryCards[0].querySelector('p').textContent = `${singleChoice}道错题待复习`;
                categoryCards[0].querySelector('.text-xs.bg-red-100').textContent = `${singleChoice}题`;
                
                categoryCards[1].querySelector('p').textContent = `${multiChoice}道错题待复习`;
                categoryCards[1].querySelector('.text-xs.bg-red-100').textContent = `${multiChoice}题`;
                
                categoryCards[2].querySelector('p').textContent = `${judgment}道错题待复习`;
                categoryCards[2].querySelector('.text-xs.bg-red-100').textContent = `${judgment}题`;
            }
        }
        
        // 渲染错题列表
        function renderWrongQuestions() {
            // 最近错题区域已被移除，不需要渲染
            // 检查是否显示空状态
            toggleEmptyState(wrongQuestions.length === 0);
        }
        
        // 创建错题元素
        function createQuestionElement(question, index) {
            try {
                const div = document.createElement('div');
                div.className = 'card-hover bg-white rounded-2xl p-4 border border-gray-200 cursor-pointer';
                div.onclick = () => {
                    try {
                        reviewQuestion(question.id);
                    } catch (error) {
                        console.error('点击错题元素失败:', error);
                        alert('点击错题失败: ' + error.message);
                    }
                };
                
                const difficultyClass = {
                    '简单': 'difficulty-easy',
                    '中等': 'difficulty-medium',
                    '困难': 'difficulty-hard'
                }[question.difficulty];
                
                const typeColor = {
                    '单选题': 'bg-blue-100 text-blue-600',
                    '多选题': 'bg-green-100 text-green-600',
                    '判断题': 'bg-orange-100 text-orange-600'
                }[question.type];
                
                div.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-red-600 font-semibold text-sm">${index}</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm mb-2">
                                ${question.question}
                            </p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs ${typeColor} px-2 py-1 rounded-full">${question.type}</span>
                                    <span class="text-xs ${difficultyClass} text-white px-2 py-1 rounded-full">${question.difficulty}</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">错误${question.wrongCount}次</span>
                                </div>
                                <span class="text-xs text-gray-500">${question.lastWrongTime}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                return div;
            } catch (error) {
                console.error('创建错题元素失败:', error);
                const errorElement = document.createElement('div');
                errorElement.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
                errorElement.textContent = '创建错题元素失败: ' + error.message;
                return errorElement;
            }
        }
        
        // 切换空状态
        function toggleEmptyState(isEmpty) {
            const emptyState = document.getElementById('emptyState');
            const contentSections = document.querySelectorAll('.px-6.py-4, .px-6.py-2');
            
            if (isEmpty) {
                emptyState.classList.remove('hidden');
                contentSections.forEach(section => {
                    if (!section.querySelector('#emptyState')) {
                        section.style.display = 'none';
                    }
                });
            } else {
                emptyState.classList.add('hidden');
                contentSections.forEach(section => {
                    section.style.display = 'block';
                });
            }
        }
        
        // 开始复习
        function startReview() {
            // 获取选择的题型
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            
            let toReviewQuestions = wrongQuestions.filter(q => q.status === '待复习');
            
            // 根据选择的题型筛选
            toReviewQuestions = toReviewQuestions.filter(q => q.type === selectedType);
            
            if (toReviewQuestions.length === 0) {
                WebViewCompat.dialog.alert(`暂无${selectedType}待复习的错题`);
                return;
            }
            
            // 不清除现有进度，允许继续之前的练习
            
            // 保存练习状态，包括选择的题型
            const practiceState = {
                mode: 'wrongQuestions',
                selectedType: selectedType,
                questions: toReviewQuestions,
                startTime: new Date().toISOString()
            };
            WebViewCompat.storage.setItem('wrongPracticeState', JSON.stringify(practiceState));
            
            const questionIds = toReviewQuestions.map(q => q.id).join(',');
            const typeParam = `&type=${encodeURIComponent(selectedType)}`;
            if (window.parent !== window) {
                window.parent.postMessage({ action: 'navigate', page: 'question', params: `?mode=wrong&questions=${questionIds}${typeParam}` }, '*');
            } else {
                // 确保题型参数正确传递
                let typeValue = '';
                if (selectedType === '单选题') {
                    typeValue = 'single';
                } else if (selectedType === '多选题') {
                    typeValue = 'multiple';
                } else if (selectedType === '判断题') {
                    typeValue = 'judge';
                } else {
                    typeValue = selectedType;
                }
                
                window.location.href = `question.html?mode=wrong&questions=${questionIds}&type=${typeValue}`;
            }
        }
        
        // 随机练习
        function randomPractice() {
            // 获取选择的题型
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            
            let practiceQuestions = [...wrongQuestions];
            
            // 根据选择的题型筛选
            practiceQuestions = practiceQuestions.filter(q => q.type === selectedType);
            
            if (practiceQuestions.length === 0) {
                WebViewCompat.dialog.alert(`暂无${selectedType}错题可供练习`);
                return;
            }
            
            // 打乱题目顺序
            const shuffledQuestions = practiceQuestions.sort(() => Math.random() - 0.5);
            
            // 转换题型为英文格式，用于URL参数 - 使用typeMap
            
            // 对每个题目的选项进行打乱处理（判断题除外）
            shuffledQuestions.forEach(question => {
                // 随机打乱选项顺序（判断题除外）
                if (question.type !== '判断题' && question.options && question.options.length > 0) {
                    // 创建选项和正确答案的映射关系
                    const optionsWithCorrectness = [];
                    
                    if (question.type === '单选题') {
                        // 单选题：correct是单个索引
                        const correctIndex = Array.isArray(question.correct) ? question.correct[0] : question.correct;
                        
                        // 将选项和是否为正确答案配对
                        question.options.forEach((option, index) => {
                            optionsWithCorrectness.push({
                                text: option,
                                isCorrect: index === correctIndex
                            });
                        });
                        
                        // 使用Fisher-Yates算法打乱选项顺序
                        for (let i = optionsWithCorrectness.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithCorrectness[i], optionsWithCorrectness[j]] = [optionsWithCorrectness[j], optionsWithCorrectness[i]];
                        }
                        
                        // 更新选项和正确答案索引
                        const newOptions = [];
                        let newCorrectIndex = -1;
                        
                        optionsWithCorrectness.forEach((item, index) => {
                            newOptions.push(item.text);
                            if (item.isCorrect) {
                                newCorrectIndex = index;
                            }
                        });
                        
                        question.options = newOptions;
                        question.correct = newCorrectIndex;
                        
                        // 保存选项映射关系，以便在答题后显示正确的解析
                        question.optionsMapping = optionsWithCorrectness;
                    } else if (question.type === '多选题') {
                        // 多选题：correct是数组
                        // 将选项和是否为正确答案配对
                        question.options.forEach((option, index) => {
                            optionsWithCorrectness.push({
                                text: option,
                                isCorrect: question.correct.includes(index)
                            });
                        });
                        
                        // 使用Fisher-Yates算法打乱选项顺序
                        for (let i = optionsWithCorrectness.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithCorrectness[i], optionsWithCorrectness[j]] = [optionsWithCorrectness[j], optionsWithCorrectness[i]];
                        }
                        
                        // 更新选项和正确答案索引
                        const newOptions = [];
                        const newCorrectIndices = [];
                        
                        optionsWithCorrectness.forEach((item, index) => {
                            newOptions.push(item.text);
                            if (item.isCorrect) {
                                newCorrectIndices.push(index);
                            }
                        });
                        
                        question.options = newOptions;
                        question.correct = newCorrectIndices;
                        
                        // 保存选项映射关系，以便在答题后显示正确的解析
                        question.optionsMapping = optionsWithCorrectness;
                    }
                }
            });
            
            // 清除当前题型的练习进度（开始新练习）
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            
            // 清除特定题型的进度
            const englishType = typeMap[selectedType];
            if (englishType) {
                const progressKey = `wrongPracticeProgress_${englishType}`;
                WebViewCompat.storage.removeItem(progressKey);
            }
            
            // 保存练习状态，包括选择的题型
            const practiceState = {
                mode: 'randomPractice',
                selectedType: selectedType,
                questions: shuffledQuestions,
                startTime: new Date().toISOString()
            };
            WebViewCompat.storage.setItem('wrongPracticeState', JSON.stringify(practiceState));
            
            const questionIds = shuffledQuestions.map(q => q.id).join(',');
            // 使用英文格式的题型参数
            const typeParam = `&type=${encodeURIComponent(typeMap[selectedType] || selectedType)}`;
            if (window.parent !== window) {
                window.parent.postMessage({ action: 'navigate', page: 'question', params: `?mode=wrong&questions=${questionIds}${typeParam}` }, '*');
            } else {
                window.location.href = `question.html?mode=wrong&questions=${questionIds}${typeParam}`;
            }
        }
        
        // 复习单个错题
        function reviewQuestion(questionId) {
            try {
                console.log('点击错题，ID:', questionId);
                if (window.parent !== window) {
                    window.parent.postMessage({ action: 'navigate', page: 'review', params: `?mode=single&questionId=${questionId}` }, '*');
                } else {
                    window.location.href = `review.html?mode=single&questionId=${questionId}`;
                }
            } catch (error) {
                console.error('复习错题失败:', error);
                alert('复习错题失败: ' + error.message);
            }
        }
        
        // 继续练习
        // 题型变化处理
        function onQuestionTypeChange() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select.value;
            currentFilter = selectedType;
            renderWrongQuestions();
            // 使用新的wrongPractice对象更新界面状态
            wrongPractice.updateButtonStates();
        }
        
        // 错题练习对象 - 封装所有练习相关功能
        // 错题练习对象 - 封装所有练习相关功能
        const wrongPractice = {
            // 类型映射表
            typeMap: {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            },
            
            // 检查特定题型是否有进度
            checkTypeProgress: function(questionType) {
                const englishType = this.typeMap[questionType] || 'single';
                const progressKey = `wrongPracticeProgress_${englishType}`;
                const savedProgress = WebViewCompat.storage.getItem(progressKey);
                
                if (!savedProgress) return null;
                
                try {
                    const progressData = JSON.parse(savedProgress);
                    
                    // 检查保存时间是否超过24小时
                    const timeDiff = Date.now() - progressData.lastSaveTime;
                    if (timeDiff > 24 * 60 * 60 * 1000) {
                        WebViewCompat.storage.removeItem(progressKey);
                        console.log('进度已过期，已清除:', progressKey);
                        return null;
                    }
                    
                    // 检查练习模式是否匹配
                    if (progressData.practiceMode !== 'wrong') {
                        console.log('练习模式不匹配，期望: wrong，实际:', progressData.practiceMode);
                        return null;
                    }
                    
                    console.log('找到有效的错题练习进度:', progressData);
                    return progressData;
                } catch (error) {
                    console.error('检查进度失败:', error);
                    WebViewCompat.storage.removeItem(progressKey);
                    return null;
                }
            },
            
            // 检查所有题型的进度
            checkAllProgress: function() {
                const types = ['单选题', '多选题', '判断题'];
                const results = {};
                
                for (const type of types) {
                    results[type] = this.checkTypeProgress(type);
                }
                
                return results;
            },
            
            // 检查当前选择题型的进度
            checkProgress: function() {
                const select = document.getElementById('questionTypeFilter');
                const selectedType = select ? select.value : '单选题';
                return this.checkTypeProgress(selectedType);
            },
            
            // 更新所有按钮状态
            updateButtonStates: function() {
                const allProgress = this.checkAllProgress();
                const select = document.getElementById('questionTypeFilter');
                const selectedType = select ? select.value : '单选题';
                
                // 更新每种题型的按钮状态
                for (const type in this.typeMap) {
                    this.updateTypeButtonState(type, allProgress[type]);
                }
            },
            
            // 更新特定题型的按钮状态
            updateTypeButtonState: function(questionType, progress) {
                if (!this.typeMap[questionType]) return;
                
                const englishType = this.typeMap[questionType];
                const continueCard = document.getElementById(`${englishType}-continue-card`);
                const continueBtn = document.getElementById(`${englishType}-continue-btn`);
                const progressInfo = document.getElementById(`${englishType}-progress-info`);
                
                if (!continueCard || !continueBtn || !progressInfo) return;
                
                if (progress) {
                    // 有进度时，显示继续练习区域
                    continueCard.style.display = 'block';
                    
                    // 启用继续练习按钮
                    continueBtn.disabled = false;
                    continueBtn.style.opacity = '1';
                    continueBtn.style.pointerEvents = 'auto';
                    
                    // 更新进度信息
                    const currentProgress = Math.round(((progress.currentQuestionIndex + 1) / progress.totalQuestions) * 100);
                    progressInfo.textContent = `第${progress.currentQuestionIndex + 1}题/共${progress.totalQuestions}题 (${currentProgress}%)`;
                } else {
                    // 无进度时，隐藏继续练习区域
                    continueCard.style.display = 'none';
                }
            },
            
            // 继续练习
            continuePractice: function(questionType) {
                const progress = this.checkTypeProgress(questionType);
                
                if (!progress) {
                    WebViewCompat.dialog.alert('未找到练习进度');
                    return;
                }
                
                // 获取当前练习的题目
                let questionsToUse = [];
                if (progress.questions && Array.isArray(progress.questions)) {
                    questionsToUse = progress.questions;
                    
                    // 确保只筛选当前题型的题目
                    questionsToUse = questionsToUse.filter(q => q.type === questionType);
                    console.log('筛选后的题目数量:', questionsToUse.length, '题型:', questionType);
                    
                    // 对每个题目的选项进行打乱处理（判断题除外）
                    questionsToUse.forEach(question => {
                        // 随机打乱选项顺序（判断题除外）
                        if (question.type !== '判断题' && question.options && question.options.length > 0) {
                            // 创建选项和正确答案的映射关系
                            const optionsWithCorrectness = [];
                            
                            if (question.type === '单选题') {
                                // 单选题：correct是单个索引
                                question.options.forEach((option, index) => {
                                    optionsWithCorrectness.push({
                                        text: option,
                                        isCorrect: index === question.correct,
                                        originalIndex: index  // 保存原始索引
                                    });
                                });
                            } else {
                                // 多选题：correct是索引数组
                                question.options.forEach((option, index) => {
                                    optionsWithCorrectness.push({
                                        text: option,
                                        isCorrect: Array.isArray(question.correct) && question.correct.includes(index),
                                        originalIndex: index  // 保存原始索引
                                    });
                                });
                            }
                            
                            // 随机打乱选项顺序
                            for (let i = optionsWithCorrectness.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [optionsWithCorrectness[i], optionsWithCorrectness[j]] = [optionsWithCorrectness[j], optionsWithCorrectness[i]];
                            }
                            
                            // 保存打乱后的选项顺序映射（用于显示选项时的字母标识）
                            question.optionMapping = optionsWithCorrectness.map(item => item.originalIndex);
                            
                            // 更新选项和正确答案
                            question.options = optionsWithCorrectness.map(item => item.text);
                            
                            if (question.type === '单选题') {
                                // 更新单选题的正确答案索引
                                question.correct = optionsWithCorrectness.findIndex(item => item.isCorrect);
                            } else {
                                // 更新多选题的正确答案索引数组
                                question.correct = optionsWithCorrectness.reduce((indexes, item, index) => {
                                    if (item.isCorrect) indexes.push(index);
                                    return indexes;
                                }, []);
                            }
                        }
                    });
                    
                    // 更新进度中的题目数据
                    const englishType = this.typeMap[questionType] || 'single';
                    const progressKey = `wrongPracticeProgress_${englishType}`;
                    progress.questions = questionsToUse;
                    WebViewCompat.storage.setItem(progressKey, JSON.stringify(progress));
                }
                
                // 跳转到question.html并传递错题练习参数
                // 确保传递正确的题型参数，不要使用'all'
                // 修复：当questionType为'单选题'时，确保传递'单选题'而不是'all'
                const typeParam = this.typeMap[questionType] || questionType;
                console.log('继续练习传递的题型参数:', typeParam, '原始题型:', questionType, '映射后:', this.typeMap[questionType]);
                
                // 获取题目ID列表，与startPractice保持一致
                const questionIds = questionsToUse.map(q => q.id).join(',');
                console.log('继续练习传递的题目IDs:', questionIds);
                
                if (window.parent !== window) {
                    window.parent.postMessage({ 
                        action: 'navigate', 
                        page: 'question', 
                        params: `?mode=wrong&questions=${questionIds}&type=${encodeURIComponent(typeParam)}&continue=true` 
                    }, '*');
                } else {
                    window.location.href = `question.html?mode=wrong&questions=${questionIds}&type=${encodeURIComponent(typeParam)}&continue=true`;
                }
            },
            
            // 开始新练习
            startPractice: function(questionType) {
                // 获取当前筛选的错题
                let questionsToUse = [];
                questionsToUse = allWrongQuestions.filter(q => q.type === questionType && q.status !== '已掌握');
                
                if (questionsToUse.length === 0) {
                    WebViewCompat.dialog.alert('没有可练习的错题');
                    return;
                }
                
                // 不再对题目顺序进行打乱，保持原始顺序
                // 对每个题目的选项进行打乱处理（判断题除外）
                questionsToUse.forEach(question => {
                    // 随机打乱选项顺序（判断题除外）
                    if (question.type !== '判断题' && question.options && question.options.length > 0) {
                        // 创建选项和正确答案的映射关系
                        const optionsWithCorrectness = [];
                        
                        if (question.type === '单选题') {
                            // 单选题：correct是单个索引
                            question.options.forEach((option, index) => {
                                optionsWithCorrectness.push({
                                    text: option,
                                    isCorrect: index === question.correct,
                                    originalIndex: index  // 保存原始索引
                                });
                            });
                        } else {
                            // 多选题：correct是索引数组
                            question.options.forEach((option, index) => {
                                optionsWithCorrectness.push({
                                    text: option,
                                    isCorrect: Array.isArray(question.correct) && question.correct.includes(index),
                                    originalIndex: index  // 保存原始索引
                                });
                            });
                        }
                        
                        // 随机打乱选项顺序
                        for (let i = optionsWithCorrectness.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithCorrectness[i], optionsWithCorrectness[j]] = [optionsWithCorrectness[j], optionsWithCorrectness[i]];
                        }
                        
                        // 保存打乱后的选项顺序映射（用于显示选项时的字母标识）
                        question.optionMapping = optionsWithCorrectness.map(item => item.originalIndex);
                        
                        // 更新选项和正确答案
                        question.options = optionsWithCorrectness.map(item => item.text);
                        
                        if (question.type === '单选题') {
                            // 更新单选题的正确答案索引
                            question.correct = optionsWithCorrectness.findIndex(item => item.isCorrect);
                        } else {
                            // 更新多选题的正确答案索引数组
                            question.correct = optionsWithCorrectness.reduce((indexes, item, index) => {
                                if (item.isCorrect) indexes.push(index);
                                return indexes;
                            }, []);
                        }
                    }
                });
                
                // 清除旧的练习进度
                const englishType = this.typeMap[questionType] || 'single';
                const progressKey = `wrongPracticeProgress_${englishType}`;
                WebViewCompat.storage.removeItem(progressKey);
                
                // 跳转到练习页面，保持题目顺序
                const questionIds = questionsToUse.map(q => q.id).join(',');
                console.log('开始错题练习，题目IDs:', questionIds);
                console.log('题目顺序:', questionsToUse.map(q => q.question));
                
                // 转换题型为英文格式，用于URL参数
                const typeParam = this.typeMap[questionType] || questionType;
                console.log('开始练习传递的题型参数:', typeParam, '原始题型:', questionType);
                
                if (window.parent !== window) {
                    window.parent.postMessage({ 
                        action: 'navigate', 
                        page: 'question', 
                        params: `?mode=wrong&type=${encodeURIComponent(typeParam)}&questions=${encodeURIComponent(questionIds)}` 
                    }, '*');
                } else {
                    window.location.href = `question.html?mode=wrong&type=${encodeURIComponent(typeParam)}&questions=${encodeURIComponent(questionIds)}`;
                }
            },
            
            // 清除练习进度
            clearProgress: function(questionType) {
                if (WebViewCompat.dialog.confirm('确定要清除当前练习进度吗？\n\n此操作不可恢复。')) {
                    const englishType = this.typeMap[questionType];
                    if (englishType) {
                        const progressKey = `wrongPracticeProgress_${englishType}`;
                        WebViewCompat.storage.removeItem(progressKey);
                    }
                    
                    // 触发数据更新事件
                    window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                        detail: { type: 'progress', action: 'clear' }
                    }));
                    
                    // 向父窗口发送消息
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'practiceDataUpdated',
                            data: { type: 'progress', action: 'clear' }
                        }, '*');
                    }
                    
                    // 更新界面状态
                    this.updateButtonStates();
                    
                    WebViewCompat.dialog.alert('练习进度已清除');
                }
            }
        };
        
        // 更新界面状态 - 已由wrongPractice对象的updateButtonStates方法替代
        function updateInterfaceState() {
            // 调用wrongPractice对象的方法更新界面
            wrongPractice.updateButtonStates();
        }
        
        // 继续练习 - 已由wrongPractice对象的continuePractice方法替代
        function continuePractice() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            wrongPractice.continuePractice(selectedType);
        }
        
        // 开始新练习 - 已由wrongPractice对象的startPractice方法替代
        function startNewPractice() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            wrongPractice.startPractice(selectedType);
        }
        
        // 清除练习进度功能 - 已由wrongPractice对象的clearProgress方法替代
        function clearPracticeProgress() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            wrongPractice.clearProgress(selectedType);
        }
        
        // 筛选错题
        function filterQuestions(type) {
            currentFilter = type;
            renderWrongQuestions();
        }
        
        // 题目类型筛选（下拉框）
        function filterByQuestionType() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select.value;
            currentFilter = selectedType;
            renderWrongQuestions();
        }
        
        // 排序错题
        function sortQuestions(sortType) {
            currentSort = sortType;
            renderWrongQuestions();
        }
        
        // 删除错题
        function removeWrongQuestion(questionId) {
            const index = wrongQuestions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                wrongQuestions.splice(index, 1);
                // 同时从allWrongQuestions中删除
                const allIndex = allWrongQuestions.findIndex(q => q.id === questionId);
                if (allIndex !== -1) {
                    allWrongQuestions.splice(allIndex, 1);
                }
                // 保存到localStorage
                WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(allWrongQuestions));
                
                updateStatistics();
                renderWrongQuestions();
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { type: 'wrongQuestions', action: 'delete', questionId }
                }));
                
                // 向父窗口发送消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'practiceDataUpdated',
                        data: { type: 'wrongQuestions', action: 'delete', questionId }
                    }, '*');
                }
            }
        }
        
        // 标记为已掌握
        function markAsMastered(questionId) {
            const question = wrongQuestions.find(q => q.id === questionId);
            if (question) {
                question.status = '已掌握';
                // 同时更新allWrongQuestions中的状态
                const allQuestion = allWrongQuestions.find(q => q.id === questionId);
                if (allQuestion) {
                    allQuestion.status = '已掌握';
                }
                // 保存到localStorage
                WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(allWrongQuestions));
                
                updateStatistics();
                renderWrongQuestions();
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { type: 'wrongQuestions', action: 'mastered', questionId }
                }));
                
                // 向父窗口发送消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'practiceDataUpdated',
                        data: { type: 'wrongQuestions', action: 'mastered', questionId }
                    }, '*');
                }
            }
        }
        
        // 绑定事件
        function bindEvents() {
            // 返回按钮
            const backBtn = document.querySelector('.fas.fa-arrow-left');
            if (backBtn) {
                backBtn.onclick = () => {
                    // 优先使用 WebView 通信
                    if (window.parent !== window) {
                        window.parent.postMessage({ action: 'navigate', page: 'index' }, '*');
                    } else {
                        // 直接跳转到首页
                        window.location.href = 'index.html';
                    }
                };
            }
            
            // 筛选按钮
            const filterBtn = document.querySelector('.fas.fa-filter');
            if (filterBtn) {
                filterBtn.onclick = showFilterMenu;
            }
            
            // 搜索按钮
            const searchBtn = document.querySelector('.fas.fa-search');
            if (searchBtn) {
                searchBtn.onclick = showSearchDialog;
            }
            
            // 快捷操作按钮
            const actionButtons = document.querySelectorAll('.grid.grid-cols-2 button');
            if (actionButtons.length >= 2) {
                actionButtons[0].onclick = startReview;
                actionButtons[1].onclick = randomPractice;
            }
            
            // 分类卡片点击
            const categoryCards = document.querySelectorAll('.space-y-3 .card-hover');
            if (categoryCards.length >= 3) {
                categoryCards[0].onclick = () => filterQuestions('单选题');
                categoryCards[1].onclick = () => filterQuestions('多选题');
                categoryCards[2].onclick = () => filterQuestions('判断题');
            }
            
            // 查看全部
            const viewAllBtn = document.querySelector('.text-sm.text-blue-600');
            if (viewAllBtn) {
                viewAllBtn.onclick = () => filterQuestions('all');
            }
            
            // 空状态按钮
            const emptyStateButton = document.querySelector('#emptyState button');
            if (emptyStateButton) {
                emptyStateButton.onclick = () => {
                    if (window.parent !== window) {
                        window.parent.postMessage({ action: 'navigate', page: 'select' }, '*');
                    } else {
                        window.location.href = 'select.html';
                    }
                };
            }
            
            // 继续练习按钮
            const continueBtn = document.querySelector('#continue-practice-section button');
            if (continueBtn) {
                continueBtn.onclick = continuePractice;
            }
            
            // 开始新练习按钮
            const newPracticeBtn = document.querySelector('#new-practice-section button');
            if (newPracticeBtn) {
                newPracticeBtn.onclick = startNewPractice;
            }
            
            // 清除进度按钮
            const clearProgressBtn = document.querySelector('#continue-practice-section .text-red-500');
            if (clearProgressBtn) {
                clearProgressBtn.onclick = clearPracticeProgress;
            }
            
            // 题型筛选下拉框
            const questionTypeFilter = document.getElementById('questionTypeFilter');
            if (questionTypeFilter) {
                questionTypeFilter.onchange = () => {
                    onQuestionTypeChange();
                    updateInterfaceState();
                };
            }
            
            // 底部导航
            const navItems = document.querySelectorAll('.nav-item');
            
            function navigateToPage(page) {
                window.NavigationUtils.navigateToPage(page);
            }
            
            navItems.forEach((item) => {
                item.onclick = () => {
                    const page = item.getAttribute('data-page');
                    if (page === 'wrong') {
                        // 已在错题页面，无需跳转
                        return;
                    }
                    navigateToPage(page);
                };
            });
        }
        
        // 显示筛选菜单
        function showFilterMenu() {
            const options = ['单选题', '多选题', '判断题', '按错误次数', '按难度', '按时间'];
            const choice = WebViewCompat.dialog.prompt('选择筛选条件：\n' + options.map((opt, i) => `${i + 1}. ${opt}`).join('\n'));
            
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < 3) {
                    currentFilter = options[index];
                } else if (index >= 3 && index < 6) {
                    currentSort = ['wrongCount', 'difficulty', 'time'][index - 3];
                }
                renderWrongQuestions();
            }
        }
        
        // 显示搜索对话框
        function showSearchDialog() {
            const keyword = WebViewCompat.dialog.prompt('请输入搜索关键词：');
            if (keyword) {
                const filteredQuestions = wrongQuestions.filter(q => 
                    q.question.includes(keyword) || 
                    q.explanation.includes(keyword)
                );
                
                if (filteredQuestions.length === 0) {
                    WebViewCompat.dialog.alert('未找到相关错题');
                } else {
                    // 临时显示搜索结果
                    const container = document.querySelector('.px-6.py-4.pb-24 .space-y-3');
                    container.innerHTML = '';
                    filteredQuestions.forEach((question, index) => {
                        const questionElement = createQuestionElement(question, index + 1);
                        container.appendChild(questionElement);
                    });
                }
            }
        }
        
        // 重置错题库
        function resetWrongQuestions() {
            if (WebViewCompat.dialog.confirm('确定要清空所有错题吗？此操作不可恢复！')) {
                WebViewCompat.storage.removeItem('wrongQuestions');
                wrongQuestions = [];
                allWrongQuestions = [];
                updateStatistics();
                renderWrongQuestions();
                WebViewCompat.dialog.alert('错题库已清空');
            }
        }
    </script>
</body>
</html>