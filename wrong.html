<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>错题库</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="common-styles.css">
    <script src="webview-compat.js"></script>
    <script src="theme-manager.js"></script>
    <script src="utils.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        /* card-hover样式已移至common-styles.css */
        .empty-state {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .difficulty-easy { background: linear-gradient(135deg, #10b981, #34d399); }
        .difficulty-medium { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .difficulty-hard { background: linear-gradient(135deg, #ef4444, #f87171); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 主内容区域 -->
    <div class="bg-white min-h-screen">
        <!-- 头部导航 -->
        <div class="bg-white px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <i class="fas fa-arrow-left text-gray-600 text-lg cursor-pointer"></i>
                <h1 class="text-xl font-semibold text-gray-800">错题库</h1>
                <div class="w-6"></div> <!-- 占位符保持居中 -->
            </div>
        </div>

        <!-- 错题统计卡片 -->
        <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-orange-50">
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-xs text-gray-500">错题总数</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600">0</div>
                        <div class="text-xs text-gray-500">待复习</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-xs text-gray-500">已掌握</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">0%</div>
                        <div class="text-xs text-gray-500">掌握率</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 题目类型选择 -->
        <div class="px-6 py-4">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">题目类型选择</label>
                <select id="questionTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="onQuestionTypeChange()">
                    <option value="单选题">单选题</option>
                    <option value="多选题">多选题</option>
                    <option value="判断题">判断题</option>
                </select>
            </div>
            
            <!-- 继续练习区域 -->
            <div id="continue-practice-section" class="mb-4" style="display: none;">
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-2xl p-4 border-2 border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-play-circle text-green-600 text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">发现未完成的练习</h4>
                                <p id="progress-info" class="text-sm text-gray-600">单选题 - 第11题/共50题 (22%)</p>
                            </div>
                        </div>
                        <button id="clear-progress-btn" class="text-red-500 hover:text-red-700 text-sm font-medium" onclick="clearPracticeProgress()">
                            <i class="fas fa-times-circle mr-1"></i>清除进度
                        </button>
                    </div>
                    <button id="continue-practice-btn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg card-hover" onclick="continuePractice()">
                        <div class="flex items-center justify-center space-x-2">
                            <i class="fas fa-play-circle text-lg"></i>
                            <span class="text-lg">继续练习</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- 新开始练习区域 -->
            <div id="new-practice-section">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <button class="card-hover bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-2xl p-4 font-medium" onclick="startReview()">
                        <div class="flex items-center justify-center space-x-2">
                            <i class="fas fa-play"></i>
                            <span>开始练习</span>
                        </div>
                    </button>
                    <button class="card-hover bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl p-4 font-medium" onclick="randomPractice()">
                        <div class="flex items-center justify-center space-x-2">
                            <i class="fas fa-random"></i>
                            <span>随机练习</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <button class="card-hover bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-2xl p-4 font-medium w-full" onclick="resetWrongQuestions()">
                <div class="flex items-center justify-center space-x-2">
                    <i class="fas fa-trash-alt"></i>
                    <span>重置错题库</span>
                </div>
            </button>
        </div>

        <!-- 错题分类 -->
        <div class="px-6 py-2">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">错题分类</h3>
                <span class="text-sm text-gray-500">按题型分组</span>
            </div>
            
            <div class="space-y-3">
                <!-- 单选题错题 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-dot-circle text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">单选题</h4>
                                <p class="text-sm text-gray-500">0道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">0题</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- 多选题错题 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-square text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">多选题</h4>
                                <p class="text-sm text-gray-500">0道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">0题</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- 判断题错题 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-question-circle text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">判断题</h4>
                                <p class="text-sm text-gray-500">0道错题待复习</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">0题</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近错题 -->
        <div class="px-6 py-4 pb-24">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">最近错题</h3>
                <span class="text-sm text-blue-600 cursor-pointer">查看全部</span>
            </div>
            
            <div class="space-y-3">
                <!-- 错题1 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-red-600 font-semibold text-sm">1</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm mb-2">
                                在JavaScript中，以下哪个方法可以用来向数组末尾添加元素？
                            </p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">单选题</span>
                                    <span class="text-xs difficulty-medium text-white px-2 py-1 rounded-full">中等</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">错误2次</span>
                                </div>
                                <span class="text-xs text-gray-500">2小时前</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 错题2 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-red-600 font-semibold text-sm">2</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm mb-2">
                                CSS中flex布局的主轴方向默认是什么？
                            </p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">多选题</span>
                                    <span class="text-xs difficulty-easy text-white px-2 py-1 rounded-full">简单</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">错误1次</span>
                                </div>
                                <span class="text-xs text-gray-500">昨天</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 错题3 -->
                <div class="card-hover bg-white rounded-2xl p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-red-600 font-semibold text-sm">3</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm mb-2">
                                HTTP状态码404表示什么意思？
                            </p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">判断题</span>
                                    <span class="text-xs difficulty-hard text-white px-2 py-1 rounded-full">困难</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">错误3次</span>
                                </div>
                                <span class="text-xs text-gray-500">3天前</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 空状态页面（当没有错题时显示） -->
        <div id="emptyState" class="hidden px-6 py-12 text-center empty-state">
            <div class="w-32 h-32 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check-circle text-6xl text-green-500"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">太棒了！</h3>
            <p class="text-gray-500 mb-6">目前没有错题，继续保持这个好习惯</p>
            <button class="bg-gradient-to-r from-blue-500 to-purple-500 text-white font-medium px-8 py-3 rounded-2xl card-hover">
                开始新的练习
            </button>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3">
        <div class="flex justify-around items-center">
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="main">
                <i class="fas fa-home text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">首页</span>
            </div>
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="wrong">
                <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                <span class="text-xs text-red-600 font-medium">错题</span>
            </div>
        </div>
    </div>

    <script>
        // 错题数据（过滤掉已移出的错题）
        let allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
        let wrongQuestions = allWrongQuestions.filter(q => !q.isRemoved);
        
        // 当前筛选条件
        let currentFilter = '单选题'; // 单选题, 多选题, 判断题
        let currentSort = 'time'; // time, difficulty, wrongCount
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 初始化主题
                if (window.themeManager) {
                    window.themeManager.init();
                }
                
                loadWrongQuestions();
                updateStatistics();
                renderWrongQuestions();
                updateInterfaceState();
                bindEvents();
            } catch (error) {
                console.error('页面初始化失败:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });
        
        // 加载错题数据（过滤已移出的错题）
        function loadWrongQuestions() {
            allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            wrongQuestions = allWrongQuestions.filter(q => !q.isRemoved);
        }
        
        // 更新统计数据
        function updateStatistics() {
            const totalWrong = wrongQuestions.length;
            const toReview = wrongQuestions.filter(q => q.status === '待复习').length;
            const mastered = wrongQuestions.filter(q => q.status === '已掌握').length;
            const masteryRate = totalWrong > 0 ? Math.round((mastered / totalWrong) * 100) : 0;
            
            // 更新统计卡片
            const stats = document.querySelectorAll('.text-2xl.font-bold');
            stats[0].textContent = totalWrong;
            stats[1].textContent = toReview;
            stats[2].textContent = mastered;
            stats[3].textContent = masteryRate + '%';
            
            // 更新分类统计
            const singleChoice = wrongQuestions.filter(q => q.type === '单选题').length;
            const multiChoice = wrongQuestions.filter(q => q.type === '多选题').length;
            const judgment = wrongQuestions.filter(q => q.type === '判断题').length;
            
            const categoryCards = document.querySelectorAll('.space-y-3 .card-hover');
            if (categoryCards.length >= 3) {
                categoryCards[0].querySelector('p').textContent = `${singleChoice}道错题待复习`;
                categoryCards[0].querySelector('.text-xs.bg-red-100').textContent = `${singleChoice}题`;
                
                categoryCards[1].querySelector('p').textContent = `${multiChoice}道错题待复习`;
                categoryCards[1].querySelector('.text-xs.bg-red-100').textContent = `${multiChoice}题`;
                
                categoryCards[2].querySelector('p').textContent = `${judgment}道错题待复习`;
                categoryCards[2].querySelector('.text-xs.bg-red-100').textContent = `${judgment}题`;
            }
        }
        
        // 渲染错题列表
        function renderWrongQuestions() {
            const container = document.querySelector('.px-6.py-4.pb-24 .space-y-3');
            if (!container) return;
            
            let filteredQuestions = wrongQuestions;
            
            // 应用筛选
            filteredQuestions = wrongQuestions.filter(q => q.type === currentFilter);
            
            // 应用排序
            filteredQuestions.sort((a, b) => {
                switch (currentSort) {
                    case 'wrongCount':
                        return b.wrongCount - a.wrongCount;
                    case 'difficulty':
                        const difficultyOrder = {'简单': 1, '中等': 2, '困难': 3};
                        return difficultyOrder[b.difficulty] - difficultyOrder[a.difficulty];
                    default:
                        return new Date(b.lastWrongTime) - new Date(a.lastWrongTime);
                }
            });
            
            // 清空容器
            container.innerHTML = '';
            
            // 渲染错题
            filteredQuestions.forEach((question, index) => {
                const questionElement = createQuestionElement(question, index + 1);
                container.appendChild(questionElement);
            });
            
            // 检查是否显示空状态
            toggleEmptyState(filteredQuestions.length === 0);
        }
        
        // 创建错题元素
        function createQuestionElement(question, index) {
            try {
                const div = document.createElement('div');
                div.className = 'card-hover bg-white rounded-2xl p-4 border border-gray-200 cursor-pointer';
                div.onclick = () => {
                    try {
                        reviewQuestion(question.id);
                    } catch (error) {
                        console.error('点击错题元素失败:', error);
                        alert('点击错题失败: ' + error.message);
                    }
                };
                
                const difficultyClass = {
                    '简单': 'difficulty-easy',
                    '中等': 'difficulty-medium',
                    '困难': 'difficulty-hard'
                }[question.difficulty];
                
                const typeColor = {
                    '单选题': 'bg-blue-100 text-blue-600',
                    '多选题': 'bg-green-100 text-green-600',
                    '判断题': 'bg-orange-100 text-orange-600'
                }[question.type];
                
                div.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-red-600 font-semibold text-sm">${index}</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm mb-2">
                                ${question.question}
                            </p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs ${typeColor} px-2 py-1 rounded-full">${question.type}</span>
                                    <span class="text-xs ${difficultyClass} text-white px-2 py-1 rounded-full">${question.difficulty}</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">错误${question.wrongCount}次</span>
                                </div>
                                <span class="text-xs text-gray-500">${question.lastWrongTime}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                return div;
            } catch (error) {
                console.error('创建错题元素失败:', error);
                const errorElement = document.createElement('div');
                errorElement.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
                errorElement.textContent = '创建错题元素失败: ' + error.message;
                return errorElement;
            }
        }
        
        // 切换空状态
        function toggleEmptyState(isEmpty) {
            const emptyState = document.getElementById('emptyState');
            const contentSections = document.querySelectorAll('.px-6.py-4, .px-6.py-2');
            
            if (isEmpty) {
                emptyState.classList.remove('hidden');
                contentSections.forEach(section => {
                    if (!section.querySelector('#emptyState')) {
                        section.style.display = 'none';
                    }
                });
            } else {
                emptyState.classList.add('hidden');
                contentSections.forEach(section => {
                    section.style.display = 'block';
                });
            }
        }
        
        // 开始复习
        function startReview() {
            // 获取选择的题型
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : 'all';
            
            let toReviewQuestions = wrongQuestions.filter(q => q.status === '待复习');
            
            // 根据选择的题型筛选
            if (selectedType !== 'all') {
                toReviewQuestions = toReviewQuestions.filter(q => q.type === selectedType);
            }
            
            if (toReviewQuestions.length === 0) {
                const typeText = selectedType === 'all' ? '' : selectedType;
                WebViewCompat.dialog.alert(`暂无${typeText}待复习的错题`);
                return;
            }
            
            // 清除当前题型的练习进度（开始新练习）
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            
            // 清除特定题型的进度
            const englishType = typeMap[selectedType];
            if (englishType) {
                const progressKey = `wrongPracticeProgress_${englishType}`;
                WebViewCompat.storage.removeItem(progressKey);
            }
            
            // 保存练习状态，包括选择的题型
            const practiceState = {
                mode: 'wrongQuestions',
                selectedType: selectedType,
                questions: toReviewQuestions,
                startTime: new Date().toISOString()
            };
            WebViewCompat.storage.setItem('wrongPracticeState', JSON.stringify(practiceState));
            
            const questionIds = toReviewQuestions.map(q => q.id).join(',');
            const typeParam = `&type=${encodeURIComponent(selectedType)}`;
            if (window.parent !== window) {
                window.parent.postMessage({ action: 'navigate', page: 'question', params: `?mode=wrong&questions=${questionIds}${typeParam}` }, '*');
            } else {
                window.location.href = `question.html?mode=wrong&questions=${questionIds}${typeParam}`;
            }
        }
        
        // 随机练习
        function randomPractice() {
            // 获取选择的题型
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : 'all';
            
            let practiceQuestions = [...wrongQuestions];
            
            // 根据选择的题型筛选
            if (selectedType !== 'all') {
                practiceQuestions = practiceQuestions.filter(q => q.type === selectedType);
            }
            
            if (practiceQuestions.length === 0) {
                const typeText = selectedType === 'all' ? '' : selectedType;
                WebViewCompat.dialog.alert(`暂无${typeText}错题可供练习`);
                return;
            }
            
            const shuffledQuestions = practiceQuestions.sort(() => Math.random() - 0.5);
            
            // 清除当前题型的练习进度（开始新练习）
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            
            // 清除特定题型的进度
            const englishType = typeMap[selectedType];
            if (englishType) {
                const progressKey = `wrongPracticeProgress_${englishType}`;
                WebViewCompat.storage.removeItem(progressKey);
            }
            
            // 保存练习状态，包括选择的题型
            const practiceState = {
                mode: 'randomPractice',
                selectedType: selectedType,
                questions: shuffledQuestions,
                startTime: new Date().toISOString()
            };
            WebViewCompat.storage.setItem('wrongPracticeState', JSON.stringify(practiceState));
            
            const questionIds = shuffledQuestions.map(q => q.id).join(',');
            const typeParam = `&type=${encodeURIComponent(selectedType)}`;
            if (window.parent !== window) {
                window.parent.postMessage({ action: 'navigate', page: 'question', params: `?mode=wrong&questions=${questionIds}${typeParam}` }, '*');
            } else {
                window.location.href = `question.html?mode=wrong&questions=${questionIds}${typeParam}`;
            }
        }
        
        // 复习单个错题
        function reviewQuestion(questionId) {
            try {
                console.log('点击错题，ID:', questionId);
                if (window.parent !== window) {
                    window.parent.postMessage({ action: 'navigate', page: 'review', params: `?mode=single&questionId=${questionId}` }, '*');
                } else {
                    window.location.href = `review.html?mode=single&questionId=${questionId}`;
                }
            } catch (error) {
                console.error('复习错题失败:', error);
                alert('复习错题失败: ' + error.message);
            }
        }
        
        // 继续练习
        // 题型变化处理
        function onQuestionTypeChange() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select.value;
            currentFilter = selectedType;
            renderWrongQuestions();
            updateInterfaceState();
        }
        
        // 检查是否有进度
        function checkProgress() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            
            // 检查特定题型的练习进度
            const englishType = typeMap[selectedType];
            if (!englishType) return null;
            
            const progressKey = `wrongPracticeProgress_${englishType}`;
            const savedProgress = WebViewCompat.storage.getItem(progressKey);
            if (!savedProgress) return null;
            
            try {
                const progressData = JSON.parse(savedProgress);
                    
                    // 检查保存时间是否超过24小时
                    const timeDiff = Date.now() - progressData.lastSaveTime;
                    if (timeDiff > 24 * 60 * 60 * 1000) {
                        WebViewCompat.storage.removeItem(progressKey);
                        return null;
                    }
                    
                    return progressData;
                } catch (error) {
                    console.error('检查进度失败:', error);
                    WebViewCompat.storage.removeItem(progressKey);
                    return null;
                }
        }
        
        // 更新界面状态
        function updateInterfaceState() {
            const progress = checkProgress();
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : 'all';
            
            // 检查进度是否与当前设置匹配
            let isProgressValid = false;
            if (progress) {
                const typeMap = {
                    'single': '单选题',
                    'multiple': '多选题', 
                    'judge': '判断题'
                };
                
                if (selectedType === 'all') {
                    // 全部模式下，任何有效进度都可以继续
                    isProgressValid = true;
                } else {
                    // 特定题型模式下，检查类型匹配
                    const currentChineseType = selectedType;
                    const savedTypeMatches = progress.questionType === currentChineseType;
                    isProgressValid = savedTypeMatches;
                }
            }
            
            const continueSection = document.getElementById('continue-practice-section');
            const newPracticeSection = document.getElementById('new-practice-section');
            
            if (progress && isProgressValid) {
                // 显示继续练习区域
                continueSection.style.display = 'block';
                newPracticeSection.style.display = 'none';
                
                // 更新进度信息
                const progressInfo = document.getElementById('progress-info');
                const currentProgress = Math.round(((progress.currentQuestionIndex + 1) / progress.totalQuestions) * 100);
                progressInfo.textContent = `${progress.questionType} - 第${progress.currentQuestionIndex + 1}题/共${progress.totalQuestions}题 (${currentProgress}%)`;
                
            } else {
                // 显示新开始练习区域
                continueSection.style.display = 'none';
                newPracticeSection.style.display = 'block';
            }
        }
        
        // 继续练习
        function continuePractice() {
            const progress = checkProgress();
            
            if (!progress) {
                WebViewCompat.dialog.alert('未找到练习进度');
                return;
            }
            
            // 检查进度模式，决定跳转页面
            if (progress.mode === 'review') {
                // 错题复习模式，跳转到review.html
                const questionIds = progress.questions.map(q => q.id).join(',');
                if (window.parent !== window) {
                    window.parent.postMessage({ action: 'navigate', page: 'review', params: `?mode=all&questions=${questionIds}` }, '*');
                } else {
                    window.location.href = `review.html?mode=all&questions=${questionIds}`;
                }
            } else {
                // 普通练习模式，跳转到question.html
                if (window.parent !== window) {
                    window.parent.postMessage({ action: 'navigate', page: 'question', params: '?continue=true' }, '*');
                } else {
                    window.location.href = 'question.html?continue=true';
                }
            }
        }
        
        // 开始新练习
        function startNewPractice() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select ? select.value : '单选题';
            
            // 获取当前筛选的错题
            let questionsToUse = [];
            if (selectedType === 'all') {
                questionsToUse = allWrongQuestions.filter(q => q.status !== '已掌握');
            } else {
                questionsToUse = allWrongQuestions.filter(q => q.type === selectedType && q.status !== '已掌握');
            }
            
            if (questionsToUse.length === 0) {
                WebViewCompat.dialog.alert('没有可练习的错题');
                return;
            }
            
            // 清除旧的练习进度
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge',
                'all': 'all'
            };
            
            const englishType = typeMap[selectedType] || 'single';
            const progressKey = `wrongPracticeProgress_${englishType}`;
            WebViewCompat.storage.removeItem(progressKey);
            
            // 跳转到练习页面
            const questionIds = questionsToUse.map(q => q.id).join(',');
            if (window.parent !== window) {
                window.parent.postMessage({ 
                    action: 'navigate', 
                    page: 'question', 
                    params: `?mode=wrong&type=${englishType}&questions=${questionIds}` 
                }, '*');
            } else {
                window.location.href = `question.html?mode=wrong&type=${englishType}&questions=${questionIds}`;
            }
        }
        
        // 清除练习进度功能
        function clearPracticeProgress() {
            if (WebViewCompat.dialog.confirm('确定要清除当前练习进度吗？\n\n此操作不可恢复。')) {
                const select = document.getElementById('questionTypeFilter');
                const selectedType = select ? select.value : '单选题';
                
                const typeMap = {
                    '单选题': 'single',
                    '多选题': 'multiple',
                    '判断题': 'judge'
                };
                
                // 清除特定题型的进度
                const englishType = typeMap[selectedType];
                if (englishType) {
                    const progressKey = `wrongPracticeProgress_${englishType}`;
                    WebViewCompat.storage.removeItem(progressKey);
                }
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { type: 'progress', action: 'clear' }
                }));
                
                // 向父窗口发送消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'practiceDataUpdated',
                        data: { type: 'progress', action: 'clear' }
                    }, '*');
                }
                
                // 更新界面状态
                updateInterfaceState();
                
                WebViewCompat.dialog.alert('练习进度已清除');
            }
        }
        
        // 筛选错题
        function filterQuestions(type) {
            currentFilter = type;
            renderWrongQuestions();
        }
        
        // 题目类型筛选（下拉框）
        function filterByQuestionType() {
            const select = document.getElementById('questionTypeFilter');
            const selectedType = select.value;
            currentFilter = selectedType;
            renderWrongQuestions();
        }
        
        // 排序错题
        function sortQuestions(sortType) {
            currentSort = sortType;
            renderWrongQuestions();
        }
        
        // 删除错题
        function removeWrongQuestion(questionId) {
            const index = wrongQuestions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                wrongQuestions.splice(index, 1);
                // 同时从allWrongQuestions中删除
                const allIndex = allWrongQuestions.findIndex(q => q.id === questionId);
                if (allIndex !== -1) {
                    allWrongQuestions.splice(allIndex, 1);
                }
                // 保存到localStorage
                WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(allWrongQuestions));
                
                updateStatistics();
                renderWrongQuestions();
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { type: 'wrongQuestions', action: 'delete', questionId }
                }));
                
                // 向父窗口发送消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'practiceDataUpdated',
                        data: { type: 'wrongQuestions', action: 'delete', questionId }
                    }, '*');
                }
            }
        }
        
        // 标记为已掌握
        function markAsMastered(questionId) {
            const question = wrongQuestions.find(q => q.id === questionId);
            if (question) {
                question.status = '已掌握';
                // 同时更新allWrongQuestions中的状态
                const allQuestion = allWrongQuestions.find(q => q.id === questionId);
                if (allQuestion) {
                    allQuestion.status = '已掌握';
                }
                // 保存到localStorage
                WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(allWrongQuestions));
                
                updateStatistics();
                renderWrongQuestions();
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { type: 'wrongQuestions', action: 'mastered', questionId }
                }));
                
                // 向父窗口发送消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'practiceDataUpdated',
                        data: { type: 'wrongQuestions', action: 'mastered', questionId }
                    }, '*');
                }
            }
        }
        
        // 绑定事件
        function bindEvents() {
            // 返回按钮
            const backBtn = document.querySelector('.fas.fa-arrow-left');
            if (backBtn) {
                backBtn.onclick = () => {
                    // 优先使用 WebView 通信
                    if (window.parent !== window) {
                        window.parent.postMessage({ action: 'navigate', page: 'index' }, '*');
                    } else {
                        // 直接跳转到首页
                        window.location.href = 'index.html';
                    }
                };
            }
            
            // 筛选按钮
            const filterBtn = document.querySelector('.fas.fa-filter');
            if (filterBtn) {
                filterBtn.onclick = showFilterMenu;
            }
            
            // 搜索按钮
            const searchBtn = document.querySelector('.fas.fa-search');
            if (searchBtn) {
                searchBtn.onclick = showSearchDialog;
            }
            
            // 快捷操作按钮
            const actionButtons = document.querySelectorAll('.grid.grid-cols-2 button');
            if (actionButtons.length >= 2) {
                actionButtons[0].onclick = startReview;
                actionButtons[1].onclick = randomPractice;
            }
            
            // 分类卡片点击
            const categoryCards = document.querySelectorAll('.space-y-3 .card-hover');
            if (categoryCards.length >= 3) {
                categoryCards[0].onclick = () => filterQuestions('单选题');
                categoryCards[1].onclick = () => filterQuestions('多选题');
                categoryCards[2].onclick = () => filterQuestions('判断题');
            }
            
            // 查看全部
            const viewAllBtn = document.querySelector('.text-sm.text-blue-600');
            if (viewAllBtn) {
                viewAllBtn.onclick = () => filterQuestions('all');
            }
            
            // 空状态按钮
            const emptyStateButton = document.querySelector('#emptyState button');
            if (emptyStateButton) {
                emptyStateButton.onclick = () => {
                    if (window.parent !== window) {
                        window.parent.postMessage({ action: 'navigate', page: 'select' }, '*');
                    } else {
                        window.location.href = 'select.html';
                    }
                };
            }
            
            // 继续练习按钮
            const continueBtn = document.querySelector('#continue-practice-section button');
            if (continueBtn) {
                continueBtn.onclick = continuePractice;
            }
            
            // 开始新练习按钮
            const newPracticeBtn = document.querySelector('#new-practice-section button');
            if (newPracticeBtn) {
                newPracticeBtn.onclick = startNewPractice;
            }
            
            // 清除进度按钮
            const clearProgressBtn = document.querySelector('#continue-practice-section .text-red-500');
            if (clearProgressBtn) {
                clearProgressBtn.onclick = clearPracticeProgress;
            }
            
            // 题型筛选下拉框
            const questionTypeFilter = document.getElementById('questionTypeFilter');
            if (questionTypeFilter) {
                questionTypeFilter.onchange = () => {
                    onQuestionTypeChange();
                    updateInterfaceState();
                };
            }
            
            // 底部导航
            const navItems = document.querySelectorAll('.nav-item');
            
            function navigateToPage(page) {
                window.NavigationUtils.navigateToPage(page);
            }
            
            navItems.forEach((item) => {
                item.onclick = () => {
                    const page = item.getAttribute('data-page');
                    if (page === 'wrong') {
                        // 已在错题页面，无需跳转
                        return;
                    }
                    navigateToPage(page);
                };
            });
        }
        
        // 显示筛选菜单
        function showFilterMenu() {
            const options = ['单选题', '多选题', '判断题', '按错误次数', '按难度', '按时间'];
            const choice = WebViewCompat.dialog.prompt('选择筛选条件：\n' + options.map((opt, i) => `${i + 1}. ${opt}`).join('\n'));
            
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < 3) {
                    currentFilter = options[index];
                } else if (index >= 3 && index < 6) {
                    currentSort = ['wrongCount', 'difficulty', 'time'][index - 3];
                }
                renderWrongQuestions();
            }
        }
        
        // 显示搜索对话框
        function showSearchDialog() {
            const keyword = WebViewCompat.dialog.prompt('请输入搜索关键词：');
            if (keyword) {
                const filteredQuestions = wrongQuestions.filter(q => 
                    q.question.includes(keyword) || 
                    q.explanation.includes(keyword)
                );
                
                if (filteredQuestions.length === 0) {
                    WebViewCompat.dialog.alert('未找到相关错题');
                } else {
                    // 临时显示搜索结果
                    const container = document.querySelector('.px-6.py-4.pb-24 .space-y-3');
                    container.innerHTML = '';
                    filteredQuestions.forEach((question, index) => {
                        const questionElement = createQuestionElement(question, index + 1);
                        container.appendChild(questionElement);
                    });
                }
            }
        }
        
        // 重置错题库
        function resetWrongQuestions() {
            if (WebViewCompat.dialog.confirm('确定要清空所有错题吗？此操作不可恢复！')) {
                WebViewCompat.storage.removeItem('wrongQuestions');
                wrongQuestions = [];
                allWrongQuestions = [];
                updateStatistics();
                renderWrongQuestions();
                WebViewCompat.dialog.alert('错题库已清空');
            }
        }
    </script>
</body>
</html>