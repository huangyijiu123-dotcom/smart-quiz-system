<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>答题界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="common-styles.css">
    <script src="webview-compat.js"></script>
    <script src="theme-manager.js"></script>
    <script src="utils.js"></script>
    <script src="questionBank.js?v=20250906"></script>
    <style>
        /* 页面特定样式 */
    </style>
</head>
<body class="bg-gray-50">
    <!-- 主内容区域 -->
    <div class="bg-white min-h-screen">
        <!-- 头部进度区域 -->
        <div class="bg-white px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-arrow-left text-gray-600 text-lg cursor-pointer"></i>
                    <span id="question-type-title" class="text-lg font-semibold text-gray-800">单选题练习</span>
                </div>
                <!-- 时间限制已移除 -->
            </div>
            
            <!-- 进度条 -->
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600" id="progress-text">第 1 题 / 共 <span id="total-questions">50</span> 题</span>
                <span class="text-sm font-medium text-blue-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- 题目状态标签 -->
        <div class="px-6 py-3 bg-gray-50">
            <div class="flex items-center space-x-3">
                <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">
                    <i class="fas fa-check mr-1"></i>已掌握: 0题
                </span>
                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">
                    <i class="fas fa-question mr-1"></i>未掌握: 0题
                </span>
            </div>
        </div>

        <!-- 题目内容 -->
        <div class="px-6 py-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span id="question-number" class="text-blue-600 font-semibold text-sm">1</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-800 leading-relaxed">
                            在JavaScript中，以下哪个方法可以用来向数组末尾添加一个或多个元素？
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选项区域 -->
        <div class="px-6 pb-6">
            <div class="space-y-3">
                <!-- 选项A -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'A', true)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">A</span>
                        </div>
                        <span class="text-gray-800 font-medium">push()</span>
                    </div>
                </div>

                <!-- 选项B -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'B', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">B</span>
                        </div>
                        <span class="text-gray-800 font-medium">pop()</span>
                    </div>
                </div>

                <!-- 选项C -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'C', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">C</span>
                        </div>
                        <span class="text-gray-800 font-medium">shift()</span>
                    </div>
                </div>

                <!-- 选项D -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'D', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">D</span>
                        </div>
                        <span class="text-gray-800 font-medium">unshift()</span>
                    </div>
                </div>

                <!-- 选项E -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'E', false)" style="display: none;">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">E</span>
                        </div>
                        <span class="text-gray-800 font-medium">选项E</span>
                    </div>
                </div>

                <!-- 选项F -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'F', false)" style="display: none;">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">F</span>
                        </div>
                        <span class="text-gray-800 font-medium">选项F</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="px-6 pb-24">
            <div class="flex space-x-3">
                <button class="flex-1 bg-gray-100 text-gray-600 font-medium py-3 rounded-xl" onclick="markQuestion('unknown')">
                    <i class="fas fa-question-circle mr-2"></i>不会
                </button>
                <button class="flex-1 bg-blue-100 text-blue-600 font-medium py-3 rounded-xl" onclick="nextQuestion()">
                    <i class="fas fa-arrow-right mr-2"></i>下一题
                </button>
            </div>
        </div>
    </div>

    <!-- 答案弹窗 -->
    <div id="answerPopup" class="fixed inset-0 flex items-center justify-center z-[9999]" style="display: none;">
        <div class="absolute inset-0 bg-black bg-opacity-60" onclick="closePopup()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-4 z-10 overflow-hidden transform transition-all" onclick="event.stopPropagation()">
            <!-- 弹窗头部 -->
            <div id="popupHeader" class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="resultIcon" class="w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-xl"></i>
                    </div>
                    <div>
                        <h3 id="resultTitle" class="font-semibold text-lg dark:text-white">回答正确！</h3>
                        <p id="resultSubtitle" class="text-sm text-gray-500 dark:text-gray-400">继续保持</p>
                    </div>
                </div>
                
                <!-- 倒计时 -->
                <div id="countdownContainer" class="relative w-12 h-12">
                    <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                        <circle id="countdownCircle" cx="50" cy="50" r="45" stroke="#3b82f6" stroke-width="8" fill="none" class="countdown-circle"></circle>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="countdownText" class="text-sm font-semibold text-blue-600 dark:text-blue-400">3</span>
                    </div>
                </div>
            </div>
            
            <!-- 弹窗内容 -->
            <div class="p-6">
                <div id="correctAnswer" class="hidden mb-6">
                    <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">正确答案：</h4>
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-500 dark:bg-green-600 rounded-full flex items-center justify-center">
                                <span id="correctLetter" class="text-white font-semibold text-sm">A</span>
                            </div>
                            <span id="correctText" class="text-green-800 dark:text-green-400 font-medium">push()</span>
                        </div>
                    </div>
                </div>
                
                <!-- 按钮区域 -->
                <div class="flex space-x-3">
                    <button class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-medium py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="closePopup()">
                        知道了
                    </button>
                    <button class="flex-1 bg-blue-600 text-white font-medium py-3 rounded-xl hover:bg-blue-700 transition-colors" onclick="nextQuestion()">
                        下一题
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3">
        <div class="flex justify-around items-center">
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="main">
                <i class="fas fa-home text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">首页</span>
            </div>
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="wrong">
                <i class="fas fa-exclamation-triangle text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">错题</span>
            </div>
        </div>
    </div>

    <script>
        // 从URL参数获取题目类型和数量
        const urlParams = new URLSearchParams(window.location.search);
        const questionType = urlParams.get('type') || '单选题';
        const questionCount = parseInt(urlParams.get('count')) || 50;
        const isContinueMode = urlParams.get('continue') === 'true';
        const practiceMode = urlParams.get('mode') || 'normal'; // 添加练习模式参数
        
        console.log('URL参数 - 题目类型:', questionType);
        console.log('URL参数 - 题目数量:', questionCount);
        console.log('URL参数 - 继续模式:', isContinueMode);
        console.log('URL参数 - 练习模式:', practiceMode);
        console.log('完整URL:', window.location.href);
        
        // 更新页面标题显示
        function updatePageTitle() {
            const titleElement = document.getElementById('question-type-title');
            if (titleElement) {
                // 处理题型显示
                let displayType = questionType;
                // 添加对映射后题型的处理
                if (questionType === 'single') {
                    displayType = '单选题';
                } else if (questionType === 'multiple') {
                    displayType = '多选题';
                } else if (questionType === 'judge') {
                    displayType = '判断题';
                } else if (questionType === 'practical') {
                    displayType = '实操题';
                }
                
                if (practiceMode === 'wrong') {
                    titleElement.textContent = displayType + '错题练习';
                } else {
                    titleElement.textContent = displayType + '练习';
                }
                
                console.log('更新页面标题为:', titleElement.textContent, '原始题型:', questionType);
                // 添加调试信息
                console.log('URL参数详情:', window.location.search);
                console.log('题型参数:', questionType);
                console.log('练习模式:', practiceMode);
                console.log('是否继续模式:', isContinueMode);
            }
        }
        
        // 从题库获取题目数据
        let questions = [];
        let currentQuestionIndex = 0;
        let totalQuestions = questionCount;
        
        // 使用统一的题目格式转换函数
        function convertQuestionFormat(question) {
            return window.QuestionUtils.convertQuestionFormat(question, questionType);
        }
        
        // 等待题库加载完成后初始化题目
        function initializeQuestions() {
            console.log('开始初始化题目...');
            console.log('window.questionBank存在:', !!window.questionBank);
            console.log('window.questionBank类型:', typeof window.questionBank);
            
            // 检查是否为错题练习模式
            if (practiceMode === 'wrong') {
                console.log('错题练习模式，从错题库获取题目...');
                
                // 检查URL参数中是否有指定的题目ID列表
                const questionsParam = urlParams.get('questions');
                if (questionsParam) {
                    console.log('使用URL参数中指定的题目ID:', questionsParam);
                    // 将ID转换为数字，但保留原始字符串以便同时匹配字符串ID和数字ID
                    const questionIds = questionsParam.split(',');
                    const questionIdsNum = questionIds.map(id => parseInt(id));
                    
                    // 从localStorage获取错题数据
                    const wrongQuestionsList = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
                    console.log('错题库数据:', wrongQuestionsList);
                    
                    // 根据ID获取指定的错题（同时匹配字符串ID和数字ID）
                    // 保持题目顺序与ID列表顺序一致
                    questions = [];
                    questionIds.forEach(id => {
                        const question = wrongQuestionsList.find(q => String(q.id) === id || q.id === parseInt(id));
                        if (question) {
                            questions.push(question);
                        }
                    });
                    console.log('根据ID筛选的题目数量:', questions.length);
                    console.log('筛选到的题目:', questions);
                } else {
                    // 没有指定题目ID，使用原有的筛选逻辑
                    const wrongQuestionsList = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
                    console.log('错题库数据:', JSON.stringify(wrongQuestionsList));
                    // 打印每个错题的详细信息，便于调试
                    wrongQuestionsList.forEach((q, index) => {
                        console.log(`错题${index+1}:`, 
                            '题目:', q.question.substring(0, 20) + '...', 
                            '类型:', q.type, 
                            '正确答案:', q.correct, 
                            '是否数组:', Array.isArray(q.correct));
                    });
                    
                    // 根据题目类型筛选错题
                    console.log('根据题型筛选错题，当前题型:', questionType);
                    const filteredWrongQuestions = wrongQuestionsList.filter(q => {
                        // 优先使用题目的type字段进行匹配，同时处理中英文题型
                        const chineseType = questionType === 'single' ? '单选题' : 
                                          questionType === 'multiple' ? '多选题' : 
                                          questionType === 'judge' ? '判断题' :
                                          questionType === 'practical' ? '实操题' : questionType;
                        
                        if (q.type && (q.type === questionType || q.type === chineseType)) {
                            console.log('根据type字段匹配到题目:', q.question, 'type:', q.type, '筛选类型:', questionType, '中文类型:', chineseType);
                            return true;
                        }
                        
                        // 如果没有type字段或type字段不匹配，则使用选项和正确答案特征判断
                        if (questionType === '判断题') {
                            return q.options && q.options.length === 2 && 
                                   q.options.includes('正确') && q.options.includes('错误');
                        } else if (questionType === '多选题') {
                            console.log('检查多选题:', q.question, '正确答案:', q.correct, '是否数组:', Array.isArray(q.correct));
                            return Array.isArray(q.correct) && q.correct.length > 1;
                        } else if (questionType === '单选题') {
                            // 单选题：correct可能是数字或长度为1的数组
                            return !Array.isArray(q.correct) || (Array.isArray(q.correct) && q.correct.length === 1);
                        } else {
                            // 如果没有指定题型或题型为'all'，返回所有错题
                            return true;
                        }
                    });
                    
                    console.log('筛选后的错题数量:', filteredWrongQuestions.length);
                    questions = filteredWrongQuestions.slice(0, questionCount);
                }
                
                if (questions.length > 0) {
                    totalQuestions = questions.length;
                    console.log('错题练习题目数量:', questions.length);
                } else {
                    console.log('没有找到对应类型的错题，显示提示信息');
                    // 显示无错题提示
                    setTimeout(() => {
                        alert(`暂无${questionType}错题，请先进行正常练习产生错题后再使用错题练习功能。`);
                        window.history.back();
                    }, 100);
                    return;
                }
                
                return;
            }
            
            if (window.questionBank) {
                console.log('题库已加载，获取题目...');
                console.log('questionBank对象:', window.questionBank);
                
                // 获取练习设置
                const practiceSettings = JSON.parse(WebViewCompat.storage.getItem('practiceSettings') || '{}');
                const practiceSettingsMode = practiceSettings.mode || { sequential: true, random: false };
                
                console.log('练习设置:', practiceSettings);
                console.log('练习模式:', practiceSettingsMode);
                
                // 根据练习模式获取题目
                const isSequential = practiceSettingsMode.sequential && !practiceSettingsMode.random;
                console.log('是否顺序练习:', isSequential);
                
                questions = questionBank.getQuestionsByMode(questionType, questionCount, isSequential);
                console.log('获取到的题目数量:', questions.length);
                console.log('题目获取模式:', isSequential ? '顺序' : '随机');
                totalQuestions = questionCount;
            } else {
                console.log('题库未加载，根据题目类型使用默认题目');
                console.log('当前window对象的属性:', Object.keys(window));
                
                // 根据题目类型提供相应的默认题目
                if (questionType === '判断题') {
                    questions = [
                        {
                            id: 1,
                            question: "职业道德是从事一定职业的人们在职业活动过程中所应遵循的道德原则和行为规范的总和。",
                            options: ["正确", "错误"],
                            correct: [0]
                        }
                    ];
                } else if (questionType === '多选题') {
                    questions = [
                        {
                            id: 1,
                            question: "以下哪些属于计算机硬件组成部分？",
                            options: ["CPU", "内存", "硬盘", "操作系统", "应用软件"],
                            correct: [0, 1, 2]
                        }
                    ];
                } else {
                    // 单选题默认题目
                    questions = [
                        {
                            id: 1,
                            question: "在JavaScript中，以下哪个方法可以用来向数组末尾添加一个或多个元素？",
                            options: ["push()", "pop()", "shift()", "unshift()"],
                            correct: 0,
                            explanation: "push() 方法将一个或多个元素添加到数组的末尾，并返回该数组的新长度。这是JavaScript中最常用的数组操作方法之一。",
                            tags: ["JavaScript", "数组操作", "基础"]
                        }
                    ];
                }
                totalQuestions = Math.min(questionCount, questions.length);
            }
            
            console.log('初始化完成 - 题目数量:', questions.length, '总题目数:', totalQuestions);
        }
        
        // 当前状态
        let correctCount = 0;
        let wrongCount = 0;
        let countdownTimer;
        let countdownSeconds = 3;
        // 时间限制已移除
        let selectedAnswers = []; // 多选题选中的答案
        let multipleChoiceSubmitted = false; // 多选题是否已提交
        let startTime = new Date(); // 记录练习开始时间
        let correctQuestions = []; // 记录答对的题目ID
        let wrongQuestions = []; // 记录答错的题目ID
        let practiceId = null; // 练习会话ID
        let autoNextScheduled = false; // 是否已安排自动下一题
        
        // 进度保存函数
        function saveProgress() {
            if (!practiceId) return;
            
            // 在错题练习模式下使用questions.length作为totalQuestions的值
            const actualTotalQuestions = practiceMode === 'wrong' ? questions.length : totalQuestions;
            
            const progressData = {
                practiceId: practiceId,
                questionType: questionType,
                questionCount: questionCount,
                currentQuestionIndex: currentQuestionIndex,
                totalQuestions: actualTotalQuestions, // 使用根据练习模式确定的题目总数
                correctCount: correctCount,
                wrongCount: wrongCount,
                // 时间限制已移除
                startTime: startTime.getTime(),
                correctQuestions: correctQuestions,
                wrongQuestions: wrongQuestions,
                questions: questions, // 保存题目顺序，确保顺序不变
                lastSaveTime: Date.now(),
                practiceMode: practiceMode, // 添加练习模式标识
                questionIds: practiceMode === 'wrong' ? questions.map(q => q.id) : null // 保存错题ID顺序
            }
            
            // 根据题目类型和练习模式确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge',
                '实操题': 'practical'
            };
            const englishType = typeMap[questionType] || 'single';
            
            // 错题练习和普通练习使用不同的存储键
            let progressKey;
            if (practiceMode === 'wrong') {
                progressKey = `wrongPracticeProgress_${englishType}`;
            } else {
                progressKey = `practiceProgress_${englishType}`;
            }
            
            WebViewCompat.storage.setItem(progressKey, JSON.stringify(progressData));
            console.log('进度已保存:', progressData, '存储键:', progressKey);
        }
        
        // 进度恢复函数
        function restoreProgress() {
            // 根据题目类型和练习模式确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge',
                '实操题': 'practical'
            };
            const englishType = typeMap[questionType] || 'single';
            
            // 错题练习和普通练习使用不同的存储键
            let progressKey;
            if (practiceMode === 'wrong') {
                progressKey = `wrongPracticeProgress_${englishType}`;
            } else {
                progressKey = `practiceProgress_${englishType}`;
            }
            
            const savedProgress = WebViewCompat.storage.getItem(progressKey);
            if (!savedProgress) return false;
            
            try {
                const progressData = JSON.parse(savedProgress);
                
                // 检查是否是同一类型、数量和练习模式的练习
                if (progressData.questionType !== questionType || 
                    progressData.questionCount !== questionCount ||
                    progressData.practiceMode !== practiceMode) {
                    console.log('进度不匹配:', {
                        saved: { type: progressData.questionType, count: progressData.questionCount, mode: progressData.practiceMode },
                        current: { type: questionType, count: questionCount, mode: practiceMode }
                    });
                    return false;
                }
                
                // 检查保存时间是否超过24小时
                const timeDiff = Date.now() - progressData.lastSaveTime;
                if (timeDiff > 24 * 60 * 60 * 1000) {
                    WebViewCompat.storage.removeItem(progressKey);
                    return false;
                }
                
                // 恢复进度
                practiceId = progressData.practiceId;
                currentQuestionIndex = progressData.currentQuestionIndex;
                totalQuestions = progressData.totalQuestions;
                correctCount = progressData.correctCount;
                wrongCount = progressData.wrongCount;
                // 时间限制已移除
                startTime = new Date(progressData.startTime);
                correctQuestions = progressData.correctQuestions || [];
                wrongQuestions = progressData.wrongQuestions || [];
                
                // 确保题目顺序与保存时一致
                if (progressData.practiceMode === 'wrong' && progressData.questionIds && progressData.questionIds.length > 0) {
                    // 如果是错题练习模式且有保存的题目ID顺序，则从错题库中按照保存的ID顺序重新获取题目
                    const wrongQuestionsList = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
                    questions = [];
                    progressData.questionIds.forEach(id => {
                        const question = wrongQuestionsList.find(q => String(q.id) === String(id) || q.id === id);
                        if (question) {
                            questions.push(question);
                        }
                    });
                    console.log('根据保存的ID顺序恢复题目，数量:', questions.length);
                } else {
                    // 否则直接使用保存的题目数组
                    questions = progressData.questions || [];
                }
                
                // 验证恢复的数据完整性
                if (!questions || questions.length === 0) {
                    console.error('恢复的题目数组为空，清除进度');
                    WebViewCompat.storage.removeItem(progressKey);
                    return false;
                }
                
                // 确保当前题目索引在有效范围内
                if (currentQuestionIndex >= questions.length) {
                    console.error('恢复的题目索引超出范围:', currentQuestionIndex, '题目总数:', questions.length);
                    currentQuestionIndex = Math.min(currentQuestionIndex, questions.length - 1);
                }
                
                console.log('进度已恢复:', progressData, '存储键:', progressKey);
                console.log('当前题目索引:', currentQuestionIndex, '题目总数:', questions.length);
                return true;
            } catch (error) {
                console.error('恢复进度失败:', error);
                WebViewCompat.storage.removeItem(progressKey);
                return false;
            }
        }
        
        // 清除进度
        function clearProgress() {
            // 根据题目类型和练习模式确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            const englishType = typeMap[questionType] || 'single';
            
            // 错题练习和普通练习使用不同的存储键
            let progressKey;
            if (practiceMode === 'wrong') {
                progressKey = `wrongPracticeProgress_${englishType}`;
            } else {
                progressKey = `practiceProgress_${englishType}`;
            }
            
            WebViewCompat.storage.removeItem(progressKey);
            console.log('进度已清除，存储键:', progressKey);
        }
        
        // 页面初始化
        window.onload = function() {
            // 延迟执行，确保所有脚本都已加载
            setTimeout(function() {
                // 生成练习会话ID
                practiceId = 'practice_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // 检查是否为继续练习模式
                if (isContinueMode) {
                    console.log('继续练习模式，尝试恢复进度...');
                    const hasProgress = restoreProgress();
                    
                    if (hasProgress) {
                        // 自动继续之前的练习，不显示弹窗
                        console.log('成功恢复进度，当前题目索引:', currentQuestionIndex);
                        
                        // 更新总题目数显示
                        document.getElementById('total-questions').textContent = totalQuestions;
                        
                        // 更新页面标题
                        updatePageTitle();
                        
                        // 更新页面显示
                        updateQuestionDisplay();
                        // 时间限制已移除
                        
                        // 恢复进度后不需要再次保存，避免索引重复增加
                        return;
                    } else {
                        console.log('无法恢复进度，开始新的练习');
                        // 继续执行下面的新练习初始化逻辑
                    }
                }
                
                // 检查是否有保存的进度（非继续模式下的自动检查）
                if (!isContinueMode) {
                    const hasProgress = restoreProgress();
                    
                    if (hasProgress) {
                        // 自动继续之前的练习，不显示弹窗
                        console.log('自动继续之前的练习，当前题目索引:', currentQuestionIndex);
                        
                        // 更新总题目数显示
                        document.getElementById('total-questions').textContent = totalQuestions;
                        
                        // 更新页面标题
                        updatePageTitle();
                        
                        // 更新页面显示
                        updateQuestionDisplay();
                        // 时间限制已移除
                        
                        // 恢复进度后不需要再次保存，避免索引重复增加
                        return;
                    } else {
                        console.log('没有有效的保存进度，开始新的练习');
                        // 继续执行下面的新练习初始化逻辑
                    }
                }
                
                // 没有进度，开始新的练习
                // 检查题库是否已加载，如果没有则等待更长时间
                if (!window.questionBank) {
                    console.log('题库未加载，等待更长时间...');
                    setTimeout(function() {
                         initializeQuestions();
                         
                         console.log('设置总题目数为:', totalQuestions);
                         console.log('题库中实际题目数:', questions.length);
                         
                         // 在错题练习模式下，打印题目顺序，用于调试
                         if (practiceMode === 'wrong') {
                             console.log('错题练习模式 - 题目顺序:');
                             questions.forEach((q, index) => {
                                 console.log(`${index + 1}. ID: ${q.id}, 题目: ${q.question}`);
                             });
                         }
                         
                         // 更新总题目数显示
                         document.getElementById('total-questions').textContent = totalQuestions;
                         
                         // 更新页面标题
                         updatePageTitle();
                         
                         // 更新页面显示
                         updateQuestionDisplay();
                         // 时间限制已移除
                         
                         // 保存初始进度
                         saveProgress();
                     }, 500);
                } else {
                     // 先初始化题目
                     initializeQuestions();
                     
                     console.log('设置总题目数为:', totalQuestions);
                     console.log('题库中实际题目数:', questions.length);
                     
                     // 在错题练习模式下，打印题目顺序，用于调试
                     if (practiceMode === 'wrong') {
                         console.log('错题练习模式 - 题目顺序:');
                         questions.forEach((q, index) => {
                             console.log(`${index + 1}. ID: ${q.id}, 题目: ${q.question}`);
                         });
                     }
                     
                     // 更新总题目数显示
                     document.getElementById('total-questions').textContent = totalQuestions;
                     
                     // 更新页面标题
                     updatePageTitle();
                     
                     // 更新页面显示
                     updateQuestionDisplay();
                     // 时间限制已移除
                     
                     // 保存初始进度
                     saveProgress();
                 }
             }, 100);
        };
        
        function updateQuestionDisplay() {
            // 检查题目数组是否为空
            if (!questions || questions.length === 0) {
                console.error('题目数组为空，无法显示题目');
                return;
            }
            
            // 确保题目索引在有效范围内
            if (currentQuestionIndex >= questions.length) {
                console.error('题目索引超出范围:', currentQuestionIndex, '题目总数:', questions.length);
                // 如果索引超出范围，重置为最后一题
                currentQuestionIndex = questions.length - 1;
            }
            
            // 打印当前显示的题目信息，用于调试
            console.log('显示题目 - 索引:', currentQuestionIndex, '题目:', questions[currentQuestionIndex].question);
            
            let question = questions[currentQuestionIndex];
            
            // 检查是否为correctAnswers/wrongAnswers格式，如果是则转换为options/correct格式
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            // 更新进度 - 在错题练习模式下使用questions.length而不是totalQuestions
            const totalQuestionsToUse = practiceMode === 'wrong' ? questions.length : totalQuestions;
            const progress = ((currentQuestionIndex + 1) / totalQuestionsToUse) * 100;
            document.querySelector('.progress-bar').style.width = progress + '%';
            document.querySelector('.text-sm.font-medium.text-blue-600').textContent = Math.round(progress) + '%';
            
            // 更新当前题目显示
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                progressText.innerHTML = `第 ${currentQuestionIndex + 1} 题 / 共 <span id="total-questions-display">${totalQuestionsToUse}</span> 题`;
            }
            
            // 更新题目编号
            const questionNumber = document.getElementById('question-number');
            if (questionNumber) {
                questionNumber.textContent = currentQuestionIndex + 1;
            }
            
            // 更新题目内容
            document.querySelector('h3.text-lg').textContent = question.question;
            
            // 更新选项
            const options = document.querySelectorAll('.option-hover');
            
            // 根据题目类型判断交互方式
            // 判断题：选项只有两个且为"正确"和"错误"
            // 单选题：correct是数字，选项有多个
            // 多选题：correct是数组且长度大于1，选项有多个
            const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                     question.options.includes('正确') && question.options.includes('错误');
            const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
            
            // 检查是否有选项映射（打乱后的选项顺序）
            const hasOptionMapping = question.optionMapping && Array.isArray(question.optionMapping);
            
            // 判断题只显示两个选项
            if (isJudgmentQuestion) {
                options.forEach((option, index) => {
                    if (index < 2) {
                        option.style.display = 'block';
                        const labels = ['正确', '错误'];
                        option.querySelector('span.font-semibold').textContent = index === 0 ? '√' : '×';
                        option.querySelector('span.text-gray-800').textContent = labels[index];
                        option.onclick = () => selectOption(option, labels[index], question.correct.includes(index));
                    } else {
                        option.style.display = 'none';
                    }
                    // 重置样式
                    option.className = 'option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer';
                });
            } else {
                // 单选题和多选题显示所有选项
                options.forEach((option, index) => {
                    if (index < question.options.length) {
                        option.style.display = 'block';
                        // 使用原始索引或映射后的索引来显示选项字母
                        const displayIndex = hasOptionMapping ? question.optionMapping[index] : index;
                        const letter = String.fromCharCode(65 + displayIndex); // A, B, C, D, E, F
                        option.querySelector('span.font-semibold').textContent = letter;
                        option.querySelector('span.text-gray-800').textContent = question.options[index];
                        
                        if (isMultipleChoice) {
                            option.onclick = () => toggleMultipleChoice(option, index);
                        } else {
                            // 单选题：correct可能是数字或数组格式
                            const correctIndex = Array.isArray(question.correct) ? question.correct[0] : question.correct;
                            option.onclick = () => selectOption(option, letter, index === correctIndex);
                        }
                    } else {
                        option.style.display = 'none';
                    }
                    // 重置样式
                    option.className = 'option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer';
                });
            }
            
            // 更新统计
            document.querySelector('.text-green-700').innerHTML = `<i class="fas fa-check mr-1"></i>已掌握: ${correctCount}题`;
            document.querySelector('.text-orange-700').innerHTML = `<i class="fas fa-question mr-1"></i>未掌握: ${wrongCount}题`;
        }
        
        // 时间限制功能已移除
        function startTimer() {
            // 此函数保留但不执行任何操作，以避免其他地方的调用出错
            return;
        }
        
        function toggleMultipleChoice(element, index) {
            if (multipleChoiceSubmitted) return;
            
            const isSelected = selectedAnswers.includes(index);
            if (isSelected) {
                // 取消选择
                selectedAnswers = selectedAnswers.filter(i => i !== index);
                element.classList.remove('bg-blue-100', 'border-blue-500');
                element.classList.add('bg-white', 'border-gray-200');
            } else {
                // 选择
                selectedAnswers.push(index);
                element.classList.remove('bg-white', 'border-gray-200');
                element.classList.add('bg-blue-100', 'border-blue-500');
            }
            
            // 显示提交按钮
            showSubmitButton();
        }
        
        function showSubmitButton() {
            let submitBtn = document.getElementById('submitMultiple');
            if (!submitBtn) {
                submitBtn = document.createElement('button');
                submitBtn.id = 'submitMultiple';
                submitBtn.className = 'w-full bg-blue-600 text-white py-3 rounded-xl font-semibold mt-4';
                submitBtn.textContent = '提交答案';
                submitBtn.onclick = submitMultipleChoice;
                document.querySelector('.space-y-3').appendChild(submitBtn);
            }
            submitBtn.style.display = selectedAnswers.length > 0 ? 'block' : 'none';
        }
        
        function submitMultipleChoice() {
            multipleChoiceSubmitted = true;
            let question = questions[currentQuestionIndex % questions.length];
            
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            // 检查答案是否正确
            const correctAnswers = question.correct.sort();
            const userAnswers = selectedAnswers.sort();
            const isCorrect = JSON.stringify(correctAnswers) === JSON.stringify(userAnswers);
            
            // 禁用所有选项
            document.querySelectorAll('.option-hover').forEach(el => {
                el.style.pointerEvents = 'none';
            });
            
            // 显示正确答案
            showCorrectAnswers(question, isCorrect, null);
            
            // 隐藏提交按钮
            document.getElementById('submitMultiple').style.display = 'none';
        }
        
        function showCorrectAnswers(question, isCorrect, selectedElement = null) {
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            const options = document.querySelectorAll('.option-hover');
            
            // 根据题目数据结构判断题目类型
            const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                     question.options.includes('正确') && question.options.includes('错误');
            const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
            
            // 检查是否有选项映射（打乱后的选项顺序）
            const hasOptionMapping = question.optionMapping && Array.isArray(question.optionMapping);
            
            if (isMultipleChoice) {
                // 多选题显示逻辑
                options.forEach((option, index) => {
                    if (question.correct.includes(index)) {
                        option.classList.remove('bg-blue-100', 'border-blue-500', 'bg-white', 'border-gray-200');
                        option.classList.add('bg-green-100', 'border-green-500');
                    } else if (selectedAnswers.includes(index)) {
                        option.classList.remove('bg-blue-100', 'border-blue-500');
                        option.classList.add('bg-red-100', 'border-red-500');
                    }
                });
            } else {
                // 单选题和判断题显示逻辑
                if (isCorrect) {
                    // 回答正确时，只给用户选择的选项添加绿框
                    if (selectedElement) {
                        selectedElement.classList.remove('bg-blue-100', 'border-blue-500', 'bg-white', 'border-gray-200');
                        selectedElement.classList.add('bg-green-100', 'border-green-500');
                    }
                } else {
                    // 回答错误时，显示正确答案的绿框和用户选择的红框
                    options.forEach((option, index) => {
                        if (isJudgmentQuestion && question.correct.includes(index)) {
                            // 判断题：correct是数组格式
                            option.classList.add('bg-green-100', 'border-green-500');
                        } else if (!isJudgmentQuestion && !isMultipleChoice && 
                                  (Array.isArray(question.correct) ? question.correct.includes(index) : index === question.correct)) {
                            // 单选题：correct可能是数字或数组格式
                            option.classList.add('bg-green-100', 'border-green-500');
                        }
                    });
                    
                    // 用户选择的错误选项显示红框
                    if (selectedElement) {
                        selectedElement.classList.add('bg-red-100', 'border-red-500');
                    }
                }
            }
            
            // 更新统计
            updateStats(isCorrect);
            
            // 显示结果弹窗
            showResultModal(isCorrect, question);
        }
        
        function updateStats(isCorrect) {
            const currentQuestion = questions[currentQuestionIndex];
            
            if (isCorrect) {
                correctCount++;
                // 记录答对的题目ID
                if (currentQuestion && currentQuestion.id) {
                    correctQuestions.push(currentQuestion.id);
                    
                    // 如果是错题练习模式，更新连续答对次数
                    if (practiceMode === 'wrong') {
                        updateConsecutiveCorrect(currentQuestion.id, true);
                    }
                }
            } else {
                wrongCount++;
                // 记录答错的题目ID
                if (currentQuestion && currentQuestion.id) {
                    wrongQuestions.push(currentQuestion.id);
                    
                    // 如果是错题练习模式，重置连续答对次数
                    if (practiceMode === 'wrong') {
                        updateConsecutiveCorrect(currentQuestion.id, false);
                    }
                }
            }
            
            // 保存今日答题记录
            const todayAnswers = JSON.parse(WebViewCompat.storage.getItem('todayAnswers') || '[]');
            todayAnswers.push({
                date: new Date().toISOString(),
                isCorrect: isCorrect,
                questionType: questionType
            });
            WebViewCompat.storage.setItem('todayAnswers', JSON.stringify(todayAnswers));
            
            // 更新页面显示的统计数据
            const masteredElement = document.querySelector('.bg-green-100 .text-green-700');
            const unmasteredElement = document.querySelector('.bg-orange-100 .text-orange-700');
            
            if (masteredElement) {
                masteredElement.innerHTML = '<i class="fas fa-check mr-1"></i>已掌握: ' + correctCount + '题';
            }
            
            if (unmasteredElement) {
                unmasteredElement.innerHTML = '<i class="fas fa-question mr-1"></i>未掌握: ' + wrongCount + '题';
            }
        }
        
        function showResultModal(isCorrect, question) {
            // 添加调试信息
            console.log('showResultModal called with isCorrect:', isCorrect);
            // 立即显示结果弹窗
            showPopup(isCorrect, question);
        }
        
        function selectOption(element, option, isCorrect) {
            console.log('selectOption called with isCorrect:', isCorrect);
            
            // 禁用所有选项
            document.querySelectorAll('.option-hover').forEach(el => {
                el.style.pointerEvents = 'none';
            });
            
            // 显示正确答案
            const question = questions[currentQuestionIndex % questions.length];
            showCorrectAnswers(question, isCorrect, element);
            
            // 更新统计
            updateStats(isCorrect);
            
            // 显示弹窗
            showPopup(isCorrect, question);
        }
        
        function showPopup(isCorrect, question) {
            console.log('showPopup called with isCorrect:', isCorrect);
            
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            // 检查是否有选项映射
            const hasOptionMapping = question.optionMapping && Array.isArray(question.optionMapping);
            
            // 获取弹窗元素
            const popup = document.getElementById('answerPopup');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultSubtitle = document.getElementById('resultSubtitle');
            const correctAnswer = document.getElementById('correctAnswer');
            const correctLetter = document.getElementById('correctLetter');
            const correctText = document.getElementById('correctText');
            
            // 获取或创建解析元素
            let explanationContainer = document.getElementById('explanationContainer');
            if (!explanationContainer) {
                explanationContainer = document.createElement('div');
                explanationContainer.id = 'explanationContainer';
                explanationContainer.className = 'mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg';
                
                const explanationTitle = document.createElement('div');
                explanationTitle.className = 'font-medium text-gray-700 dark:text-gray-300 mb-1';
                explanationTitle.textContent = '解析：';
                
                const explanationContent = document.createElement('div');
                explanationContent.id = 'explanationContent';
                explanationContent.className = 'text-gray-600 dark:text-gray-400 text-sm';
                
                explanationContainer.appendChild(explanationTitle);
                explanationContainer.appendChild(explanationContent);
                
                // 将解析容器添加到弹窗中，放在正确答案区域后面
                correctAnswer.parentNode.insertBefore(explanationContainer, correctAnswer.nextSibling);
            }
            
            // 获取用户设置
            const userSettings = JSON.parse(WebViewCompat.storage.getItem('appSettings') || '{}');
            const vibrationEnabled = userSettings.vibration !== undefined ? userSettings.vibration : false;
            const soundEnabled = userSettings.sound !== undefined ? userSettings.sound : true;
            const showExplanation = userSettings.showExplanation !== undefined ? userSettings.showExplanation : true;
            
            if (isCorrect) {
                // 设置正确状态
                resultIcon.className = 'w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center';
                resultIcon.innerHTML = '<i class="fas fa-check text-xl text-green-600 dark:text-green-400"></i>';
                
                // 如果是错题练习模式，检查连续答对次数
                if (practiceMode === 'wrong' && question.id) {
                    const consecutiveCount = getConsecutiveCorrect(question.id);
                    if (consecutiveCount >= 3) {
                        resultTitle.textContent = '恭喜！连续答对3次';
                        resultSubtitle.textContent = '该题已从错题库移除！';
                    } else {
                        resultTitle.textContent = '回答正确！';
                        resultSubtitle.textContent = `连续答对${consecutiveCount}/3次`;
                    }
                } else {
                    resultTitle.textContent = '回答正确！';
                    resultSubtitle.textContent = '继续保持';
                }
                
                // 隐藏正确答案区域
                correctAnswer.classList.add('hidden');
                
                // 隐藏解析区域
                explanationContainer.classList.add('hidden');
                
                // 播放正确音效
                if (soundEnabled) {
                    playCorrectSound();
                }
            } else {
                // 设置错误状态
                resultIcon.className = 'w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center';
                resultIcon.innerHTML = '<i class="fas fa-times text-xl text-red-600 dark:text-red-400"></i>';
                resultTitle.textContent = '回答错误';
                resultSubtitle.textContent = '查看正确答案';
                
                // 显示正确答案区域
                correctAnswer.classList.remove('hidden');
                
                // 获取当前练习模式
                const urlParams = new URLSearchParams(window.location.search);
                const currentMode = urlParams.get('mode');
                
                // 显示解析区域（如果有解析内容，且是错题练习模式或用户设置为显示解析）
                if (question.explanation && (currentMode === 'wrong' || showExplanation)) {
                    document.getElementById('explanationContent').textContent = question.explanation;
                    explanationContainer.classList.remove('hidden');
                } else {
                    explanationContainer.classList.add('hidden');
                }
                
                // 设置正确答案内容
                // 根据题目数据结构判断题目类型
                const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                         question.options.includes('正确') && question.options.includes('错误');
                const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
                
                if (isJudgmentQuestion) {
                    const correctIndex = question.correct[0];
                    const correctTextValue = question.options[correctIndex];
                    correctLetter.textContent = correctIndex === 0 ? '√' : '×';
                    correctText.textContent = correctTextValue;
                } else if (isMultipleChoice) {
                    // 使用原始索引或映射后的索引来显示正确答案字母
                    const correctLetters = question.correct.map(index => {
                        const displayIndex = hasOptionMapping ? question.optionMapping[index] : index;
                        return String.fromCharCode(65 + displayIndex);
                    }).join(', ');
                    const correctOptions = question.correct.map(index => question.options[index]).join('; ');
                    correctLetter.textContent = correctLetters;
                    correctText.textContent = correctOptions;
                } else {
                    // 单选题：correct可能是数字或数组格式
                    const correctIndex = Array.isArray(question.correct) ? question.correct[0] : question.correct;
                    // 使用原始索引或映射后的索引来显示正确答案字母
                    const displayIndex = hasOptionMapping ? question.optionMapping[correctIndex] : correctIndex;
                    const correctLetterValue = String.fromCharCode(65 + displayIndex);
                    correctLetter.textContent = correctLetterValue;
                    correctText.textContent = question.options[correctIndex];
                }
                
                // 震动反馈
                if (vibrationEnabled) {
                    WebViewCompat.vibration.vibrate(200); // 震动200毫秒
                }
                
                // 播放错误音效
                if (soundEnabled) {
                    playWrongSound();
                }
                
                // 保存错题到localStorage
                saveWrongQuestion(question);
            }
            
            // 显示弹窗
            popup.style.display = 'flex';
            
            // 检查自动下一题设置
            const autoSettings = JSON.parse(WebViewCompat.storage.getItem('appSettings') || '{}');
            const autoNext = autoSettings.autoNext !== undefined ? autoSettings.autoNext : true;
            const displayDuration = autoSettings.answerDelay || 1000; // 默认1000ms
            
            // 重置自动下一题标志
            autoNextScheduled = false;
            
            if (autoNext) {
                // 标记已安排自动下一题
                autoNextScheduled = true;
                
                // 使用设置中的显示时长来控制弹窗显示时间
                setTimeout(() => {
                    // 只有在标志仍为true时才执行自动下一题
                    if (autoNextScheduled) {
                        nextQuestion();
                    }
                }, displayDuration);
                
                // 更新倒计时显示
                countdownSeconds = Math.ceil(displayDuration / 1000);
                startCountdown();
            } else {
                // 如果关闭自动下一题，隐藏倒计时
                const countdownContainer = document.getElementById('countdownContainer');
                if (countdownContainer) {
                    countdownContainer.style.display = 'none';
                }
            }
        }
        
        // showAnswerPopup函数已完全删除
        
        // 自动下一题倒计时功能保留，但与时间限制无关
        function startCountdown() {
            const countdownText = document.getElementById('countdownText');
            const countdownCircle = document.getElementById('countdownCircle');
            let currentSeconds = countdownSeconds;
            
            countdownText.textContent = currentSeconds;
            countdownCircle.style.strokeDasharray = '283';
            countdownCircle.style.strokeDashoffset = '283';
            
            countdownTimer = setInterval(() => {
                currentSeconds--;
                countdownText.textContent = currentSeconds;
                
                // 更新圆环进度
                const progress = (countdownSeconds - currentSeconds) / countdownSeconds;
                const offset = 283 - (progress * 283);
                countdownCircle.style.strokeDashoffset = offset;
                
                if (currentSeconds <= 0) {
                    clearInterval(countdownTimer);
                    // 倒计时结束，不自动跳转，等待用户手动操作
                }
            }, 1000);
        }
        
        function saveWrongQuestion(question) {
            // 获取现有的错题库
            let wrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            
            // 检查题目是否已经在错题库中
            const existingIndex = wrongQuestions.findIndex(q => q.question === question.question);
            
            if (existingIndex !== -1) {
                // 如果题目已存在，增加错误次数
                wrongQuestions[existingIndex].wrongCount = (wrongQuestions[existingIndex].wrongCount || 1) + 1;
                wrongQuestions[existingIndex].lastWrongDate = new Date().toISOString();
                // 重置连续答对次数
                wrongQuestions[existingIndex].consecutiveCorrect = 0;
                // 确保解析内容被保存
                if (question.explanation && !wrongQuestions[existingIndex].explanation) {
                    wrongQuestions[existingIndex].explanation = question.explanation;
                }
            } else {
                // 如果题目不存在，添加新的错题记录
                const wrongQuestion = {
                    id: Date.now() + Math.random(), // 生成唯一ID
                    question: question.question,
                    options: question.options,
                    correct: question.correct,
                    explanation: question.explanation, // 保存解析内容
                    type: questionType === 'single' ? '单选题' : 
                          questionType === 'multiple' ? '多选题' : 
                          questionType === 'judge' ? '判断题' :
                          questionType === 'practical' ? '实操题' : questionType,
                    wrongCount: 1,
                    status: '待复习',
                    addedDate: new Date().toISOString(),
                    lastWrongDate: new Date().toISOString(),
                    consecutiveCorrect: 0, // 连续答对次数
                    isRemoved: false // 是否已从错题库移除
                };
                wrongQuestions.push(wrongQuestion);
            }
            
            // 保存到localStorage
            WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
        }
        
        function closePopup() {
            // 关闭弹窗
            const popup = document.getElementById('answerPopup');
            if (popup) {
                popup.style.display = 'none';
            }
            
            // 清除自动下一题倒计时（与时间限制无关）
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            // 重置圆环
            const countdownCircle = document.getElementById('countdownCircle');
            if (countdownCircle) {
                countdownCircle.style.strokeDashoffset = '283';
            }
        }
        
        function nextQuestion() {
            // 重置自动下一题标志，防止重复触发
            autoNextScheduled = false;
            
            closePopup();
            currentQuestionIndex++;
            
            // 重置多选题状态
            selectedAnswers = [];
            multipleChoiceSubmitted = false;
            
            // 隐藏提交按钮
            const submitBtn = document.getElementById('submitMultiple');
            if (submitBtn) {
                submitBtn.style.display = 'none';
            }
            
            // 打印当前题目索引和总题目数，用于调试
            console.log('下一题 - 当前题目索引:', currentQuestionIndex, '总题目数:', totalQuestions, '题目数组长度:', questions.length);
            
            // 确保在错题练习模式下使用questions.length作为结束条件，而不是totalQuestions
            if ((practiceMode === 'wrong' && currentQuestionIndex >= questions.length) || 
                (practiceMode !== 'wrong' && currentQuestionIndex >= totalQuestions)) {
                // 练习完成，清除进度
                clearProgress();
                // 时间限制已移除，不需要清除计时器
                const accuracy = Math.round((correctCount / totalQuestions) * 100);
                
                // 保存练习记录到practiceHistory
                const practiceHistory = JSON.parse(WebViewCompat.storage.getItem('practiceHistory') || '[]');
                const practiceRecord = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    dateString: new Date().toDateString(), // 添加用于日期比较的字段
                    questionType: questionType,
                    questionCount: totalQuestions,
                    correctCount: correctCount,
                    wrongCount: wrongCount,
                    accuracy: accuracy,
                    duration: Math.floor((Date.now() - startTime) / 1000), // 练习时长（秒）
                    correctQuestions: correctQuestions, // 答对的题目ID列表
                    wrongQuestions: wrongQuestions // 答错的题目ID列表
                };
                
                console.log('保存练习记录:', practiceRecord);
                practiceHistory.push(practiceRecord);
                
                // 保存练习记录到localStorage（使用Android WebView兼容性方法）
                if (window.WebViewCompat && WebViewCompat.android) {
                    WebViewCompat.android.setItemWithSync('practiceHistory', JSON.stringify(practiceHistory));
                    WebViewCompat.android.setItemWithSync('lastUpdate', Date.now().toString());
                } else {
                    WebViewCompat.storage.setItem('practiceHistory', JSON.stringify(practiceHistory));
                    WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                }
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { practiceRecord: practiceRecord }
                }));
                
                // 跨iframe通信：向父窗口发送数据更新消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        action: 'practiceDataUpdated',
                        data: practiceRecord
                    }, '*');
                }
                
                // Android WebView特定的数据同步处理
                if (window.WebViewCompat && WebViewCompat.android && WebViewCompat.android.isAndroidWebView()) {
                    setTimeout(() => {
                        // 验证数据一致性
                        if (!WebViewCompat.android.validateDataConsistency()) {
                            console.warn('数据一致性检查失败，重新保存数据');
                            WebViewCompat.storage.setItem('practiceHistory', JSON.stringify(practiceHistory));
                            WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                        }
                        // 强制触发存储同步
                        WebViewCompat.android.forceStorageSync();
                    }, 200);
                } else {
                    // 非Android WebView环境的兼容处理
                    setTimeout(() => {
                        WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                    }, 100);
                }
                
                // 移除弹窗，直接返回上一页
                // WebViewCompat.dialog.alert(`练习完成！\n正确率：${accuracy}%\n正确：${correctCount}题\n错误：${wrongCount}题`);
                goBack();
            } else {
                // 重置选项状态
                document.querySelectorAll('.option-hover').forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
                updateQuestionDisplay();
                
                // 在更新显示后保存当前进度
                saveProgress();
            }
        }
        
        function markQuestion(status) {
            const currentQuestion = questions[currentQuestionIndex];
            
            if (status === 'known') {
                correctCount++;
                // 记录答对的题目ID
                if (currentQuestion && currentQuestion.id) {
                    correctQuestions.push(currentQuestion.id);
                }
                nextQuestion();
            } else {
                // 点击"不会"按钮，直接将题目标记为错题
                wrongCount++;
                // 记录答错的题目ID
                if (currentQuestion && currentQuestion.id) {
                    wrongQuestions.push(currentQuestion.id);
                }
                saveWrongQuestion(currentQuestion);
                nextQuestion();
            }
        }
        
        function goBack() {
            // 退出前保存进度（如果练习未完成）
            if (currentQuestionIndex < totalQuestions && practiceId) {
                saveProgress();
                WebViewCompat.dialog.alert('练习进度已保存，下次进入可以继续练习。');
            }
            
            // 修复：错题练习模式下，练习完成后直接返回错题页面，而不是使用history.back()
            if (practiceMode === 'wrong') {
                console.log('错题练习完成，返回错题页面');
                if (window.parent !== window) {
                    window.parent.postMessage({ action: 'navigate', page: 'wrong' }, '*');
                } else {
                    window.location.href = 'wrong.html';
                }
                return;
            }
            
            window.history.back();
        }
        
        // 更新连续答对次数
        function updateConsecutiveCorrect(questionId, isCorrect) {
            let allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            const questionIndex = allWrongQuestions.findIndex(q => q.id === questionId);
            
            if (questionIndex !== -1) {
                if (isCorrect) {
                    // 答对了，增加连续答对次数
                    allWrongQuestions[questionIndex].consecutiveCorrect = (allWrongQuestions[questionIndex].consecutiveCorrect || 0) + 1;
                    
                    // 如果连续答对3次，标记为已移除
                    if (allWrongQuestions[questionIndex].consecutiveCorrect >= 3) {
                        allWrongQuestions[questionIndex].isRemoved = true;
                        allWrongQuestions[questionIndex].status = '已掌握';
                        allWrongQuestions[questionIndex].removedDate = new Date().toISOString();
                    }
                } else {
                    // 答错了，重置连续答对次数
                    allWrongQuestions[questionIndex].consecutiveCorrect = 0;
                }
                
                allWrongQuestions[questionIndex].lastReviewDate = new Date().toISOString();
                WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(allWrongQuestions));
            }
        }
        
        // 获取连续答对次数
        function getConsecutiveCorrect(questionId) {
            let allWrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            const question = allWrongQuestions.find(q => q.id === questionId);
            return question ? (question.consecutiveCorrect || 0) : 0;
        }
        
        // 音效播放函数
        function playCorrectSound() {
            try {
                // 使用兼容性音效播放
                WebViewCompat.audio.playTone(523.25, 300, 'sine');
            } catch (error) {
                WebViewCompat.errorHandler.warn('正确音效播放失败:', error);
            }
        }
        
        function playWrongSound() {
            try {
                // 使用兼容性音效播放
                WebViewCompat.audio.playTone(220, 300, 'sawtooth');
            } catch (error) {
                WebViewCompat.errorHandler.warn('错误音效播放失败:', error);
            }
        }
        
        // 返回按钮
        document.querySelector('.fas.fa-arrow-left').addEventListener('click', goBack);
        
        // 底部导航
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化主题
            if (window.themeManager) {
                window.themeManager.init();
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            
            function navigateToPage(page) {
                window.NavigationUtils.navigateToPage(page);
            }
            
            navItems.forEach((item) => {
                item.addEventListener('click', function() {
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });
        });
    </script>
</body>
</html>