<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>答题界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="common-styles.css">
    <script src="webview-compat.js"></script>
    <script src="theme-manager.js"></script>
    <script src="utils.js"></script>
    <script src="questionBank.js?v=20250906"></script>
    <style>
        /* 页面特定样式 */
    </style>
</head>
<body class="bg-gray-50">
    <!-- 主内容区域 -->
    <div class="bg-white min-h-screen">
        <!-- 头部进度区域 -->
        <div class="bg-white px-6 py-4 border-b border-gray-100">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-arrow-left text-gray-600 text-lg cursor-pointer"></i>
                    <span id="question-type-title" class="text-lg font-semibold text-gray-800">单选题练习</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-clock text-gray-500"></i>
                    <span id="timer-display" class="text-sm text-gray-600">12:35</span>
                </div>
            </div>
            
            <!-- 进度条 -->
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600" id="progress-text">第 1 题 / 共 <span id="total-questions">50</span> 题</span>
                <span class="text-sm font-medium text-blue-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- 题目状态标签 -->
        <div class="px-6 py-3 bg-gray-50">
            <div class="flex items-center space-x-3">
                <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">
                    <i class="fas fa-check mr-1"></i>已掌握: 0题
                </span>
                <span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">
                    <i class="fas fa-question mr-1"></i>未掌握: 0题
                </span>
            </div>
        </div>

        <!-- 题目内容 -->
        <div class="px-6 py-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span id="question-number" class="text-blue-600 font-semibold text-sm">1</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-800 leading-relaxed">
                            在JavaScript中，以下哪个方法可以用来向数组末尾添加一个或多个元素？
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选项区域 -->
        <div class="px-6 pb-6">
            <div class="space-y-3">
                <!-- 选项A -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'A', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">A</span>
                        </div>
                        <span class="text-gray-800 font-medium">push()</span>
                    </div>
                </div>

                <!-- 选项B -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'B', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">B</span>
                        </div>
                        <span class="text-gray-800 font-medium">pop()</span>
                    </div>
                </div>

                <!-- 选项C -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'C', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">C</span>
                        </div>
                        <span class="text-gray-800 font-medium">shift()</span>
                    </div>
                </div>

                <!-- 选项D -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'D', false)">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">D</span>
                        </div>
                        <span class="text-gray-800 font-medium">unshift()</span>
                    </div>
                </div>

                <!-- 选项E -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'E', false)" style="display: none;">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">E</span>
                        </div>
                        <span class="text-gray-800 font-medium">选项E</span>
                    </div>
                </div>

                <!-- 选项F -->
                <div class="option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer" onclick="selectOption(this, 'F', false)" style="display: none;">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-semibold text-gray-600">F</span>
                        </div>
                        <span class="text-gray-800 font-medium">选项F</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="px-6 pb-24">
            <div class="flex space-x-3">
                <button class="flex-1 bg-gray-100 text-gray-600 font-medium py-3 rounded-xl" onclick="markQuestion('unknown')">
                    <i class="fas fa-question-circle mr-2"></i>不会
                </button>
                <button class="flex-1 bg-blue-100 text-blue-600 font-medium py-3 rounded-xl" onclick="nextQuestion()">
                    <i class="fas fa-arrow-right mr-2"></i>下一题
                </button>
            </div>
        </div>
    </div>

    <!-- 答案弹窗 -->
    <div id="answerPopup" class="fixed inset-0 popup-overlay hidden z-50" onclick="closePopup()">
        <div class="flex items-end justify-center min-h-screen">
            <div class="popup-content bg-white rounded-t-3xl w-full max-w-md mx-4 mb-0" onclick="event.stopPropagation()">
                <!-- 弹窗头部 -->
                <div class="flex items-center justify-between p-6 border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div id="resultIcon" class="w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-xl"></i>
                        </div>
                        <div>
                            <h3 id="resultTitle" class="font-semibold text-lg">回答正确！</h3>
                            <p class="text-sm text-gray-500">继续保持</p>
                        </div>
                    </div>
                    
                    <!-- 倒计时圆环 -->
                    <div class="relative w-12 h-12">
                        <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                            <circle id="countdownCircle" cx="50" cy="50" r="45" stroke="#3b82f6" stroke-width="8" fill="none" class="countdown-circle"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="countdownText" class="text-sm font-semibold text-blue-600">3</span>
                        </div>
                    </div>
                </div>
                
                <!-- 弹窗内容 -->
                <div class="p-6">
                    <div id="correctAnswer" class="hidden">
                        <h4 class="font-medium text-gray-800 mb-2">正确答案：</h4>
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-semibold text-sm">A</span>
                                </div>
                                <span class="text-green-800 font-medium">push()</span>
                            </div>
                        </div>
                    </div>
                    

                    
                    <div class="mt-6 flex space-x-3">
                        <button class="flex-1 bg-gray-100 text-gray-600 font-medium py-3 rounded-xl" onclick="closePopup()">
                            知道了
                        </button>
                        <button class="flex-1 bg-blue-600 text-white font-medium py-3 rounded-xl" onclick="nextQuestion()">
                            下一题
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3">
        <div class="flex justify-around items-center">
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="main">
                <i class="fas fa-home text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">首页</span>
            </div>
            <div class="flex flex-col items-center space-y-1 nav-item" data-page="wrong">
                <i class="fas fa-exclamation-triangle text-gray-400 text-lg"></i>
                <span class="text-xs text-gray-400">错题</span>
            </div>
        </div>
    </div>

    <script>
        // 从URL参数获取题目类型和数量
        const urlParams = new URLSearchParams(window.location.search);
        const questionType = urlParams.get('type') || '单选题';
        const questionCount = parseInt(urlParams.get('count')) || 50;
        const isContinueMode = urlParams.get('continue') === 'true';
        
        console.log('URL参数 - 题目类型:', questionType);
        console.log('URL参数 - 题目数量:', questionCount);
        console.log('URL参数 - 继续模式:', isContinueMode);
        console.log('完整URL:', window.location.href);
        
        // 更新页面标题显示
        function updatePageTitle() {
            const titleElement = document.getElementById('question-type-title');
            if (titleElement) {
                titleElement.textContent = questionType + '练习';
            }
        }
        
        // 从题库获取题目数据
        let questions = [];
        let currentQuestionIndex = 0;
        let totalQuestions = questionCount;
        
        // 使用统一的题目格式转换函数
        function convertQuestionFormat(question) {
            return window.QuestionUtils.convertQuestionFormat(question, questionType);
        }
        
        // 等待题库加载完成后初始化题目
        function initializeQuestions() {
            console.log('开始初始化题目...');
            console.log('window.questionBank存在:', !!window.questionBank);
            console.log('window.questionBank类型:', typeof window.questionBank);
            
            if (window.questionBank) {
                console.log('题库已加载，获取题目...');
                console.log('questionBank对象:', window.questionBank);
                
                // 获取练习设置
                const practiceSettings = JSON.parse(WebViewCompat.storage.getItem('practiceSettings') || '{}');
                const practiceMode = practiceSettings.mode || { sequential: true, random: false };
                
                console.log('练习设置:', practiceSettings);
                console.log('练习模式:', practiceMode);
                
                // 根据练习模式获取题目
                const isSequential = practiceMode.sequential && !practiceMode.random;
                console.log('是否顺序练习:', isSequential);
                
                questions = questionBank.getQuestionsByMode(questionType, questionCount, isSequential);
                console.log('获取到的题目数量:', questions.length);
                console.log('题目获取模式:', isSequential ? '顺序' : '随机');
                totalQuestions = questionCount;
            } else {
                console.log('题库未加载，根据题目类型使用默认题目');
                console.log('当前window对象的属性:', Object.keys(window));
                
                // 根据题目类型提供相应的默认题目
                if (questionType === '判断题') {
                    questions = [
                        {
                            id: 1,
                            question: "职业道德是从事一定职业的人们在职业活动过程中所应遵循的道德原则和行为规范的总和。",
                            options: ["正确", "错误"],
                            correct: [0]
                        }
                    ];
                } else if (questionType === '多选题') {
                    questions = [
                        {
                            id: 1,
                            question: "以下哪些属于计算机硬件组成部分？",
                            options: ["CPU", "内存", "硬盘", "操作系统", "应用软件"],
                            correct: [0, 1, 2]
                        }
                    ];
                } else {
                    // 单选题默认题目
                    questions = [
                        {
                            id: 1,
                            question: "在JavaScript中，以下哪个方法可以用来向数组末尾添加一个或多个元素？",
                            options: ["push()", "pop()", "shift()", "unshift()"],
                            correct: 0,
                            explanation: "push() 方法将一个或多个元素添加到数组的末尾，并返回该数组的新长度。这是JavaScript中最常用的数组操作方法之一。",
                            tags: ["JavaScript", "数组操作", "基础"]
                        }
                    ];
                }
                totalQuestions = Math.min(questionCount, questions.length);
            }
            
            console.log('初始化完成 - 题目数量:', questions.length, '总题目数:', totalQuestions);
        }
        
        // 当前状态
        let correctCount = 0;
        let wrongCount = 0;
        let countdownTimer;
        let countdownSeconds = 3;
        let timeLeft = 30 * 60; // 30分钟倒计时
        let timerInterval;
        let selectedAnswers = []; // 多选题选中的答案
        let multipleChoiceSubmitted = false; // 多选题是否已提交
        let startTime = new Date(); // 记录练习开始时间
        let correctQuestions = []; // 记录答对的题目ID
        let wrongQuestions = []; // 记录答错的题目ID
        let practiceId = null; // 练习会话ID
        
        // 进度保存函数
        function saveProgress() {
            if (!practiceId) return;
            
            const progressData = {
                practiceId: practiceId,
                questionType: questionType,
                questionCount: questionCount,
                currentQuestionIndex: currentQuestionIndex,
                totalQuestions: totalQuestions,
                correctCount: correctCount,
                wrongCount: wrongCount,
                timeLeft: timeLeft,
                startTime: startTime.getTime(),
                correctQuestions: correctQuestions,
                wrongQuestions: wrongQuestions,
                questions: questions, // 保存题目顺序
                lastSaveTime: Date.now()
            };
            
            // 根据题目类型确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            const englishType = typeMap[questionType] || 'single';
            const progressKey = `practiceProgress_${englishType}`;
            
            WebViewCompat.storage.setItem(progressKey, JSON.stringify(progressData));
            console.log('进度已保存:', progressData, '存储键:', progressKey);
        }
        
        // 进度恢复函数
        function restoreProgress() {
            // 根据题目类型确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            const englishType = typeMap[questionType] || 'single';
            const progressKey = `practiceProgress_${englishType}`;
            
            const savedProgress = WebViewCompat.storage.getItem(progressKey);
            if (!savedProgress) return false;
            
            try {
                const progressData = JSON.parse(savedProgress);
                
                // 检查是否是同一类型和数量的练习
                if (progressData.questionType !== questionType || 
                    progressData.questionCount !== questionCount) {
                    return false;
                }
                
                // 检查保存时间是否超过24小时
                const timeDiff = Date.now() - progressData.lastSaveTime;
                if (timeDiff > 24 * 60 * 60 * 1000) {
                    WebViewCompat.storage.removeItem(progressKey);
                    return false;
                }
                
                // 恢复进度
                practiceId = progressData.practiceId;
                currentQuestionIndex = progressData.currentQuestionIndex;
                totalQuestions = progressData.totalQuestions;
                correctCount = progressData.correctCount;
                wrongCount = progressData.wrongCount;
                timeLeft = progressData.timeLeft;
                startTime = new Date(progressData.startTime);
                correctQuestions = progressData.correctQuestions || [];
                wrongQuestions = progressData.wrongQuestions || [];
                questions = progressData.questions || [];
                
                // 验证恢复的数据完整性
                if (!questions || questions.length === 0) {
                    console.error('恢复的题目数组为空，清除进度');
                    WebViewCompat.storage.removeItem(progressKey);
                    return false;
                }
                
                // 确保当前题目索引在有效范围内
                if (currentQuestionIndex >= questions.length) {
                    console.error('恢复的题目索引超出范围:', currentQuestionIndex, '题目总数:', questions.length);
                    currentQuestionIndex = Math.min(currentQuestionIndex, questions.length - 1);
                }
                
                console.log('进度已恢复:', progressData, '存储键:', progressKey);
                console.log('当前题目索引:', currentQuestionIndex, '题目总数:', questions.length);
                return true;
            } catch (error) {
                console.error('恢复进度失败:', error);
                WebViewCompat.storage.removeItem(progressKey);
                return false;
            }
        }
        
        // 清除进度
        function clearProgress() {
            // 根据题目类型确定存储键
            const typeMap = {
                '单选题': 'single',
                '多选题': 'multiple',
                '判断题': 'judge'
            };
            const englishType = typeMap[questionType] || 'single';
            const progressKey = `practiceProgress_${englishType}`;
            
            WebViewCompat.storage.removeItem(progressKey);
            console.log('进度已清除，存储键:', progressKey);
        }
        
        // 页面初始化
        window.onload = function() {
            // 延迟执行，确保所有脚本都已加载
            setTimeout(function() {
                // 生成练习会话ID
                practiceId = 'practice_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // 检查是否为继续练习模式
                if (isContinueMode) {
                    console.log('继续练习模式，尝试恢复进度...');
                    const hasProgress = restoreProgress();
                    
                    if (hasProgress) {
                        // 自动继续之前的练习，不显示弹窗
                        console.log('成功恢复进度，当前题目索引:', currentQuestionIndex);
                        
                        // 更新总题目数显示
                        document.getElementById('total-questions').textContent = totalQuestions;
                        
                        // 更新页面标题
                        updatePageTitle();
                        
                        // 更新页面显示
                        updateQuestionDisplay();
                        startTimer();
                        
                        // 恢复进度后不需要再次保存，避免索引重复增加
                        return;
                    } else {
                        console.log('无法恢复进度，开始新的练习');
                    }
                }
                
                // 检查是否有保存的进度（非继续模式下的自动检查）
                if (!isContinueMode) {
                    const hasProgress = restoreProgress();
                    
                    if (hasProgress) {
                        // 自动继续之前的练习，不显示弹窗
                        console.log('自动继续之前的练习，当前题目索引:', currentQuestionIndex);
                        
                        // 更新总题目数显示
                        document.getElementById('total-questions').textContent = totalQuestions;
                        
                        // 更新页面标题
                        updatePageTitle();
                        
                        // 更新页面显示
                        updateQuestionDisplay();
                        startTimer();
                        
                        // 恢复进度后不需要再次保存，避免索引重复增加
                        return;
                    }
                }
                
                // 没有进度，开始新的练习
                // 检查题库是否已加载，如果没有则等待更长时间
                if (!window.questionBank) {
                    console.log('题库未加载，等待更长时间...');
                    setTimeout(function() {
                         initializeQuestions();
                         
                         console.log('设置总题目数为:', totalQuestions);
                         console.log('题库中实际题目数:', questions.length);
                         
                         // 更新总题目数显示
                         document.getElementById('total-questions').textContent = totalQuestions;
                         
                         // 更新页面标题
                         updatePageTitle();
                         
                         // 更新页面显示
                         updateQuestionDisplay();
                         startTimer();
                         
                         // 保存初始进度
                         saveProgress();
                     }, 500);
                } else {
                     // 先初始化题目
                     initializeQuestions();
                     
                     console.log('设置总题目数为:', totalQuestions);
                     console.log('题库中实际题目数:', questions.length);
                     
                     // 更新总题目数显示
                     document.getElementById('total-questions').textContent = totalQuestions;
                     
                     // 更新页面标题
                     updatePageTitle();
                     
                     // 更新页面显示
                     updateQuestionDisplay();
                     startTimer();
                     
                     // 保存初始进度
                     saveProgress();
                 }
             }, 100);
        };
        
        function updateQuestionDisplay() {
            // 确保题目索引在有效范围内
            if (currentQuestionIndex >= questions.length) {
                console.error('题目索引超出范围:', currentQuestionIndex, '题目总数:', questions.length);
                return;
            }
            
            let question = questions[currentQuestionIndex];
            
            // 检查是否为correctAnswers/wrongAnswers格式，如果是则转换为options/correct格式
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            // 更新进度
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.querySelector('.progress-bar').style.width = progress + '%';
            document.querySelector('.text-sm.font-medium.text-blue-600').textContent = Math.round(progress) + '%';
            
            // 更新当前题目显示
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                progressText.innerHTML = `第 ${currentQuestionIndex + 1} 题 / 共 <span id="total-questions-display">${totalQuestions}</span> 题`;
            }
            
            // 更新题目编号
            const questionNumber = document.getElementById('question-number');
            if (questionNumber) {
                questionNumber.textContent = currentQuestionIndex + 1;
            }
            
            // 更新题目内容
            document.querySelector('h3.text-lg').textContent = question.question;
            
            // 更新选项
            const options = document.querySelectorAll('.option-hover');
            
            // 根据题目类型判断交互方式
            // 判断题：选项只有两个且为"正确"和"错误"
            // 单选题：correct是数字，选项有多个
            // 多选题：correct是数组且长度大于1，选项有多个
            const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                     question.options.includes('正确') && question.options.includes('错误');
            const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
            
            // 判断题只显示两个选项
            if (isJudgmentQuestion) {
                options.forEach((option, index) => {
                    if (index < 2) {
                        option.style.display = 'block';
                        const labels = ['正确', '错误'];
                        option.querySelector('span.font-semibold').textContent = index === 0 ? '√' : '×';
                        option.querySelector('span.text-gray-800').textContent = labels[index];
                        option.onclick = () => selectOption(option, labels[index], question.correct.includes(index));
                    } else {
                        option.style.display = 'none';
                    }
                    // 重置样式
                    option.className = 'option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer';
                });
            } else {
                // 单选题和多选题显示所有选项
                options.forEach((option, index) => {
                    if (index < question.options.length) {
                        option.style.display = 'block';
                        const letter = String.fromCharCode(65 + index); // A, B, C, D, E, F
                        option.querySelector('span.font-semibold').textContent = letter;
                        option.querySelector('span.text-gray-800').textContent = question.options[index];
                        
                        if (isMultipleChoice) {
                            option.onclick = () => toggleMultipleChoice(option, index);
                        } else {
                            // 单选题：correct可能是数字或数组格式
                            const correctIndex = Array.isArray(question.correct) ? question.correct[0] : question.correct;
                            option.onclick = () => selectOption(option, letter, index === correctIndex);
                        }
                    } else {
                        option.style.display = 'none';
                    }
                    // 重置样式
                    option.className = 'option-hover bg-white rounded-2xl p-4 border-2 border-gray-200 cursor-pointer';
                });
            }
            
            // 更新统计
            document.querySelector('.text-green-700').innerHTML = `<i class="fas fa-check mr-1"></i>已掌握: ${correctCount}题`;
            document.querySelector('.text-orange-700').innerHTML = `<i class="fas fa-question mr-1"></i>未掌握: ${wrongCount}题`;
        }
        
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    WebViewCompat.dialog.alert('时间到！练习结束。');
                    goBack();
                }
            }, 1000);
        }
        
        function toggleMultipleChoice(element, index) {
            if (multipleChoiceSubmitted) return;
            
            const isSelected = selectedAnswers.includes(index);
            if (isSelected) {
                // 取消选择
                selectedAnswers = selectedAnswers.filter(i => i !== index);
                element.classList.remove('bg-blue-100', 'border-blue-500');
                element.classList.add('bg-white', 'border-gray-200');
            } else {
                // 选择
                selectedAnswers.push(index);
                element.classList.remove('bg-white', 'border-gray-200');
                element.classList.add('bg-blue-100', 'border-blue-500');
            }
            
            // 显示提交按钮
            showSubmitButton();
        }
        
        function showSubmitButton() {
            let submitBtn = document.getElementById('submitMultiple');
            if (!submitBtn) {
                submitBtn = document.createElement('button');
                submitBtn.id = 'submitMultiple';
                submitBtn.className = 'w-full bg-blue-600 text-white py-3 rounded-xl font-semibold mt-4';
                submitBtn.textContent = '提交答案';
                submitBtn.onclick = submitMultipleChoice;
                document.querySelector('.space-y-3').appendChild(submitBtn);
            }
            submitBtn.style.display = selectedAnswers.length > 0 ? 'block' : 'none';
        }
        
        function submitMultipleChoice() {
            multipleChoiceSubmitted = true;
            let question = questions[currentQuestionIndex % questions.length];
            
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            // 检查答案是否正确
            const correctAnswers = question.correct.sort();
            const userAnswers = selectedAnswers.sort();
            const isCorrect = JSON.stringify(correctAnswers) === JSON.stringify(userAnswers);
            
            // 禁用所有选项
            document.querySelectorAll('.option-hover').forEach(el => {
                el.style.pointerEvents = 'none';
            });
            
            // 显示正确答案
            showCorrectAnswers(question, isCorrect, null);
            
            // 隐藏提交按钮
            document.getElementById('submitMultiple').style.display = 'none';
        }
        
        function showCorrectAnswers(question, isCorrect, selectedElement = null) {
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            const options = document.querySelectorAll('.option-hover');
            
            // 根据题目数据结构判断题目类型
            const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                     question.options.includes('正确') && question.options.includes('错误');
            const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
            
            if (isMultipleChoice) {
                // 多选题显示逻辑
                options.forEach((option, index) => {
                    if (question.correct.includes(index)) {
                        option.classList.remove('bg-blue-100', 'border-blue-500', 'bg-white', 'border-gray-200');
                        option.classList.add('bg-green-100', 'border-green-500');
                    } else if (selectedAnswers.includes(index)) {
                        option.classList.remove('bg-blue-100', 'border-blue-500');
                        option.classList.add('bg-red-100', 'border-red-500');
                    }
                });
            } else {
                // 单选题和判断题显示逻辑
                if (isCorrect) {
                    // 回答正确时，只给用户选择的选项添加绿框
                    if (selectedElement) {
                        selectedElement.classList.remove('bg-blue-100', 'border-blue-500', 'bg-white', 'border-gray-200');
                        selectedElement.classList.add('bg-green-100', 'border-green-500');
                    }
                } else {
                    // 回答错误时，显示正确答案的绿框和用户选择的红框
                    options.forEach((option, index) => {
                        if (isJudgmentQuestion && question.correct.includes(index)) {
                            // 判断题：correct是数组格式
                            option.classList.add('bg-green-100', 'border-green-500');
                        } else if (!isJudgmentQuestion && !isMultipleChoice && 
                                  (Array.isArray(question.correct) ? question.correct.includes(index) : index === question.correct)) {
                            // 单选题：correct可能是数字或数组格式
                            option.classList.add('bg-green-100', 'border-green-500');
                        }
                    });
                    
                    // 用户选择的错误选项显示红框
                    if (selectedElement) {
                        selectedElement.classList.add('bg-red-100', 'border-red-500');
                    }
                }
            }
            
            // 更新统计
            updateStats(isCorrect);
            
            // 显示结果弹窗
            showResultModal(isCorrect, question);
        }
        
        function updateStats(isCorrect) {
            const currentQuestion = questions[currentQuestionIndex];
            
            if (isCorrect) {
                correctCount++;
                // 记录答对的题目ID
                if (currentQuestion && currentQuestion.id) {
                    correctQuestions.push(currentQuestion.id);
                }
            } else {
                wrongCount++;
                // 记录答错的题目ID
                if (currentQuestion && currentQuestion.id) {
                    wrongQuestions.push(currentQuestion.id);
                }
            }
            
            // 保存今日答题记录
            const todayAnswers = JSON.parse(WebViewCompat.storage.getItem('todayAnswers') || '[]');
            todayAnswers.push({
                date: new Date().toISOString(),
                isCorrect: isCorrect,
                questionType: questionType
            });
            WebViewCompat.storage.setItem('todayAnswers', JSON.stringify(todayAnswers));
            
            // 更新页面显示的统计数据
            const masteredElement = document.querySelector('.bg-green-100 .text-green-700');
            const unmasteredElement = document.querySelector('.bg-orange-100 .text-orange-700');
            
            if (masteredElement) {
                masteredElement.innerHTML = '<i class="fas fa-check mr-1"></i>已掌握: ' + correctCount + '题';
            }
            
            if (unmasteredElement) {
                unmasteredElement.innerHTML = '<i class="fas fa-question mr-1"></i>未掌握: ' + wrongCount + '题';
            }
        }
        
        function showResultModal(isCorrect, question) {
            // 立即显示结果弹窗
            showAnswerPopup(isCorrect, question);
        }
        
        function selectOption(element, option, isCorrect) {
            // 禁用所有选项
            document.querySelectorAll('.option-hover').forEach(el => {
                el.style.pointerEvents = 'none';
            });
            
            // 显示正确答案
            const question = questions[currentQuestionIndex % questions.length];
            showCorrectAnswers(question, isCorrect, element);
        }
        
        function showAnswerPopup(isCorrect, question) {
            // 如果是correctAnswers/wrongAnswers格式，先转换
            if (question.correctAnswers && question.wrongAnswers) {
                question = convertQuestionFormat(question);
            }
            
            const popup = document.getElementById('answerPopup');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const correctAnswer = document.getElementById('correctAnswer');
            
            // 读取设置
            const userSettings = JSON.parse(WebViewCompat.storage.getItem('appSettings') || '{}');
            const vibrationEnabled = userSettings.vibration !== undefined ? userSettings.vibration : false;
            const soundEnabled = userSettings.sound !== undefined ? userSettings.sound : true;
            
            if (isCorrect) {
                resultIcon.className = 'w-10 h-10 bg-green-100 rounded-full flex items-center justify-center';
                resultIcon.innerHTML = '<i class="fas fa-check text-xl text-green-600"></i>';
                resultTitle.textContent = '回答正确！';
                correctAnswer.classList.add('hidden');
                
                // 播放正确音效
                if (soundEnabled) {
                    playCorrectSound();
                }
            } else {
                resultIcon.className = 'w-10 h-10 bg-red-100 rounded-full flex items-center justify-center';
                resultIcon.innerHTML = '<i class="fas fa-times text-xl text-red-600"></i>';
                resultTitle.textContent = '回答错误';
                correctAnswer.classList.remove('hidden');
                
                // 震动反馈
                if (vibrationEnabled) {
            WebViewCompat.vibration.vibrate(200); // 震动200毫秒
        }
                
                // 播放错误音效
                if (soundEnabled) {
                    playWrongSound();
                }
                
                // 保存错题到localStorage
                saveWrongQuestion(question);
                
                // 显示正确答案
                const optionElement = correctAnswer.querySelector('.w-6.h-6 span');
                const textElement = correctAnswer.querySelector('span.text-green-800');
                
                if (optionElement && textElement) {
                    // 根据题目数据结构判断题目类型
                    const isJudgmentQuestion = question.options && question.options.length === 2 && 
                                             question.options.includes('正确') && question.options.includes('错误');
                    const isMultipleChoice = Array.isArray(question.correct) && question.correct.length > 1;
                    
                    if (isJudgmentQuestion) {
                        const correctIndex = question.correct[0];
                        const correctText = question.options[correctIndex];
                        optionElement.textContent = correctIndex === 0 ? '√' : '×';
                        textElement.textContent = correctText;
                    } else if (isMultipleChoice) {
                        const correctLetters = question.correct.map(index => String.fromCharCode(65 + index)).join(', ');
                        const correctOptions = question.correct.map(index => question.options[index]).join('; ');
                        optionElement.textContent = correctLetters;
                        textElement.textContent = correctOptions;
                    } else {
                        // 单选题：correct可能是数字或数组格式
                        const correctIndex = Array.isArray(question.correct) ? question.correct[0] : question.correct;
                        const correctLetter = String.fromCharCode(65 + correctIndex);
                        optionElement.textContent = correctLetter;
                        textElement.textContent = question.options[correctIndex];
                    }
                }
            }
            

            
            popup.classList.remove('hidden');
            
            // 检查自动下一题设置
            const autoSettings = JSON.parse(WebViewCompat.storage.getItem('appSettings') || '{}');
            const autoNext = autoSettings.autoNext !== undefined ? autoSettings.autoNext : true;
            const displayDuration = autoSettings.answerDelay || 1000; // 默认1000ms
            
            if (autoNext) {
                // 使用设置中的显示时长来控制弹窗显示时间
                setTimeout(() => {
                    nextQuestion();
                }, displayDuration);
                
                // 更新倒计时显示
                countdownSeconds = Math.ceil(displayDuration / 1000);
                startCountdown();
            } else {
                // 如果关闭自动下一题，隐藏倒计时，只显示手动按钮
                const countdownSection = document.querySelector('#answerPopup .flex.items-center.justify-center.mb-4');
                if (countdownSection) {
                    countdownSection.style.display = 'none';
                }
            }
        }
        
        function startCountdown() {
            const countdownText = document.getElementById('countdownText');
            const countdownCircle = document.getElementById('countdownCircle');
            let currentSeconds = countdownSeconds;
            
            countdownText.textContent = currentSeconds;
            countdownCircle.style.strokeDasharray = '283';
            countdownCircle.style.strokeDashoffset = '283';
            
            countdownTimer = setInterval(() => {
                currentSeconds--;
                countdownText.textContent = currentSeconds;
                
                // 更新圆环进度
                const progress = (countdownSeconds - currentSeconds) / countdownSeconds;
                const offset = 283 - (progress * 283);
                countdownCircle.style.strokeDashoffset = offset;
                
                if (currentSeconds <= 0) {
                    clearInterval(countdownTimer);
                    // 倒计时结束，不自动跳转，等待用户手动操作
                }
            }, 1000);
        }
        
        function saveWrongQuestion(question) {
            // 获取现有的错题库
            let wrongQuestions = JSON.parse(WebViewCompat.storage.getItem('wrongQuestions') || '[]');
            
            // 检查题目是否已经在错题库中
            const existingIndex = wrongQuestions.findIndex(q => q.question === question.question);
            
            if (existingIndex !== -1) {
                // 如果题目已存在，增加错误次数
                wrongQuestions[existingIndex].wrongCount = (wrongQuestions[existingIndex].wrongCount || 1) + 1;
                wrongQuestions[existingIndex].lastWrongDate = new Date().toISOString();
            } else {
                // 如果题目不存在，添加新的错题记录
                const wrongQuestion = {
                    id: Date.now() + Math.random(), // 生成唯一ID
                    question: question.question,
                    options: question.options,
                    correct: question.correct,
                    type: questionType,
                    wrongCount: 1,
                    status: '待复习',
                    addedDate: new Date().toISOString(),
                    lastWrongDate: new Date().toISOString(),
                    consecutiveCorrect: 0, // 连续答对次数
                    isRemoved: false // 是否已从错题库移除
                };
                wrongQuestions.push(wrongQuestion);
            }
            
            // 保存到localStorage
        WebViewCompat.storage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
        }
        
        function closePopup() {
            const popup = document.getElementById('answerPopup');
            popup.classList.add('hidden');
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            // 重置圆环
            document.getElementById('countdownCircle').style.strokeDashoffset = '283';
        }
        
        function nextQuestion() {
            closePopup();
            currentQuestionIndex++;
            
            // 重置多选题状态
            selectedAnswers = [];
            multipleChoiceSubmitted = false;
            
            // 隐藏提交按钮
            const submitBtn = document.getElementById('submitMultiple');
            if (submitBtn) {
                submitBtn.style.display = 'none';
            }
            
            if (currentQuestionIndex >= totalQuestions) {
                // 练习完成，清除进度
                clearProgress();
                clearInterval(timerInterval);
                const accuracy = Math.round((correctCount / totalQuestions) * 100);
                
                // 保存练习记录到practiceHistory
                const practiceHistory = JSON.parse(WebViewCompat.storage.getItem('practiceHistory') || '[]');
                const practiceRecord = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    dateString: new Date().toDateString(), // 添加用于日期比较的字段
                    questionType: questionType,
                    questionCount: totalQuestions,
                    correctCount: correctCount,
                    wrongCount: wrongCount,
                    accuracy: accuracy,
                    duration: Math.floor((Date.now() - startTime) / 1000), // 练习时长（秒）
                    correctQuestions: correctQuestions, // 答对的题目ID列表
                    wrongQuestions: wrongQuestions // 答错的题目ID列表
                };
                
                console.log('保存练习记录:', practiceRecord);
                practiceHistory.push(practiceRecord);
                
                // 保存练习记录到localStorage（使用Android WebView兼容性方法）
                if (window.WebViewCompat && WebViewCompat.android) {
                    WebViewCompat.android.setItemWithSync('practiceHistory', JSON.stringify(practiceHistory));
                    WebViewCompat.android.setItemWithSync('lastUpdate', Date.now().toString());
                } else {
                    WebViewCompat.storage.setItem('practiceHistory', JSON.stringify(practiceHistory));
                    WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                }
                
                // 触发数据更新事件
                window.dispatchEvent(new CustomEvent('practiceDataUpdated', {
                    detail: { practiceRecord: practiceRecord }
                }));
                
                // 跨iframe通信：向父窗口发送数据更新消息
                if (window.parent !== window) {
                    window.parent.postMessage({
                        action: 'practiceDataUpdated',
                        data: practiceRecord
                    }, '*');
                }
                
                // Android WebView特定的数据同步处理
                if (window.WebViewCompat && WebViewCompat.android && WebViewCompat.android.isAndroidWebView()) {
                    setTimeout(() => {
                        // 验证数据一致性
                        if (!WebViewCompat.android.validateDataConsistency()) {
                            console.warn('数据一致性检查失败，重新保存数据');
                            WebViewCompat.storage.setItem('practiceHistory', JSON.stringify(practiceHistory));
                            WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                        }
                        // 强制触发存储同步
                        WebViewCompat.android.forceStorageSync();
                    }, 200);
                } else {
                    // 非Android WebView环境的兼容处理
                    setTimeout(() => {
                        WebViewCompat.storage.setItem('lastUpdate', Date.now().toString());
                    }, 100);
                }
                
                WebViewCompat.dialog.alert(`练习完成！\n正确率：${accuracy}%\n正确：${correctCount}题\n错误：${wrongCount}题`);
                goBack();
            } else {
                // 重置选项状态
                document.querySelectorAll('.option-hover').forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
                updateQuestionDisplay();
                
                // 在更新显示后保存当前进度
                saveProgress();
            }
        }
        
        function markQuestion(status) {
            const currentQuestion = questions[currentQuestionIndex];
            
            if (status === 'known') {
                correctCount++;
                // 记录答对的题目ID
                if (currentQuestion && currentQuestion.id) {
                    correctQuestions.push(currentQuestion.id);
                }
                nextQuestion();
            } else {
                // 点击"不会"按钮，直接将题目标记为错题
                wrongCount++;
                // 记录答错的题目ID
                if (currentQuestion && currentQuestion.id) {
                    wrongQuestions.push(currentQuestion.id);
                }
                saveWrongQuestion(currentQuestion);
                nextQuestion();
            }
        }
        
        function goBack() {
            // 退出前保存进度（如果练习未完成）
            if (currentQuestionIndex < totalQuestions && practiceId) {
                saveProgress();
                WebViewCompat.dialog.alert('练习进度已保存，下次进入可以继续练习。');
            }
            window.history.back();
        }
        
        // 音效播放函数
        function playCorrectSound() {
            try {
                // 使用兼容性音效播放
                WebViewCompat.audio.playTone(523.25, 300, 'sine');
            } catch (error) {
                WebViewCompat.errorHandler.warn('正确音效播放失败:', error);
            }
        }
        
        function playWrongSound() {
            try {
                // 使用兼容性音效播放
                WebViewCompat.audio.playTone(220, 300, 'sawtooth');
            } catch (error) {
                WebViewCompat.errorHandler.warn('错误音效播放失败:', error);
            }
        }
        
        // 返回按钮
        document.querySelector('.fas.fa-arrow-left').addEventListener('click', goBack);
        
        // 底部导航
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化主题
            if (window.themeManager) {
                window.themeManager.init();
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            
            function navigateToPage(page) {
                window.NavigationUtils.navigateToPage(page);
            }
            
            navItems.forEach((item) => {
                item.addEventListener('click', function() {
                    const page = item.getAttribute('data-page');
                    navigateToPage(page);
                });
            });
        });
    </script>
</body>
</html>